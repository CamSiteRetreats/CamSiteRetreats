<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="../favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ho√†n t·∫•t ƒë·∫∑t ch·ªó - CAM SITE RETREATS</title>

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="ƒêƒÉng k√Ω Tour - CAM SITE RETREATS">
    <meta property="og:description" content="ƒêi·ªÅn th√¥ng tin v√† ƒë·∫∑t c·ªçc Tour c√πng CAM SITE RETREATS üèîÔ∏è">
    <meta property="og:image" content="https://camsiteretreats.com/og-payment.jpg">
    <meta property="og:type" content="website">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="../js/crm.js"></script> <!-- CRM Logic -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#E85D04',
                        secondary: '#FFF8F0',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .step-active {
            border-color: #E85D04;
            color: #E85D04;
        }

        .step-point-active {
            background-color: #E85D04;
            color: white;
            border-color: #E85D04;
        }

        .waiver-box {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            color: #555;
            background: #f9fafb;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen pb-20">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-2xl mx-auto px-6 py-4 flex justify-between items-center">
            <a href="../index.html" class="flex items-center gap-2">
                <img src="../logo.png" alt="Logo" loading="lazy" class="h-16 w-auto object-contain">
            </a>
            <div class="text-xs font-bold text-gray-400 uppercase tracking-widest">
                Booking Process
            </div>
        </div>
    </header>

    <main class="max-w-2xl mx-auto px-6 py-8">

        <!-- Steps Progress -->
        <div class="flex items-center justify-between mb-10 relative">
            <div class="absolute left-0 top-1/2 w-full h-0.5 bg-gray-200 -z-10"></div>

            <!-- Step 1 -->
            <div class="flex flex-col items-center gap-2 bg-gray-50 px-2 z-10 step-indicator" data-step="1">
                <div
                    class="w-8 h-8 rounded-full border-2 border-primary bg-primary text-white flex items-center justify-center font-bold text-sm">
                    1</div>
                <span class="text-[10px] uppercase font-bold text-primary tracking-wider">C√° nh√¢n</span>
            </div>

            <!-- Step 2 -->
            <div class="flex flex-col items-center gap-2 bg-gray-50 px-2 z-10 step-indicator" data-step="2">
                <div
                    class="w-8 h-8 rounded-full border-2 border-gray-300 bg-white text-gray-400 flex items-center justify-center font-bold text-sm">
                    2</div>
                <span class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Kh·∫£o s√°t</span>
            </div>

            <!-- Step 3 -->
            <div class="flex flex-col items-center gap-2 bg-gray-50 px-2 z-10 step-indicator" data-step="3">
                <div
                    class="w-8 h-8 rounded-full border-2 border-gray-300 bg-white text-gray-400 flex items-center justify-center font-bold text-sm">
                    3</div>
                <span class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Cam k·∫øt</span>
            </div>

            <!-- Step 4 -->
            <div class="flex flex-col items-center gap-2 bg-gray-50 px-2 z-10 step-indicator" data-step="4">
                <div
                    class="w-8 h-8 rounded-full border-2 border-gray-300 bg-white text-gray-400 flex items-center justify-center font-bold text-sm">
                    4</div>
                <span class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">C·ªçc</span>
            </div>
        </div>

        <!-- Notification Area -->
        <div id="notification-area"></div>

        <form id="booking-form" onsubmit="return false;" class="space-y-8 animate__animated animate__fadeIn">

            <!-- STEP 1: PERSONAL INFO -->
            <div id="step-1" class="step-content">
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 space-y-4">
                    <h2 class="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
                        <i data-lucide="user" class="w-5 h-5 text-primary"></i> Th√¥ng tin kh√°ch h√†ng
                    </h2>

                    <!-- Tour Info Display (Read only) -->
                    <div
                        class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm bg-orange-50 p-4 rounded-xl border border-orange-100 mb-4">
                        <div>
                            <span class="block text-gray-400 text-xs uppercase font-bold mb-1">Tour</span>
                            <input type="text" id="tour-name"
                                class="w-full font-bold text-gray-800 bg-transparent border-none p-0" readonly>
                        </div>
                        <div>
                            <span class="block text-gray-400 text-xs uppercase font-bold mb-1">Ng√†y kh·ªüi h√†nh</span>
                            <input type="text" id="tour-date"
                                class="w-full font-bold text-primary bg-transparent border-none p-0" readonly>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">H·ªç v√† t√™n *</label>
                            <input type="text" id="cust-name"
                                class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:border-primary transition-colors"
                                required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Ng√†y sinh *</label>
                            <input type="date" id="cust-dob"
                                class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:border-primary transition-colors"
                                required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">S·ªë ƒëi·ªán tho·∫°i *</label>
                            <input type="tel" id="cust-phone"
                                class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:border-primary transition-colors"
                                required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Gi·ªõi t√≠nh *</label>
                            <select id="cust-gender"
                                class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:border-primary transition-colors">
                                <option value="Nam">Nam</option>
                                <option value="N·ªØ">N·ªØ</option>
                                <option value="Kh√°c">Kh√°c</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">S·ªë CCCD / H·ªô chi·∫øu *</label>
                        <input type="text" id="cust-idcard"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:border-primary transition-colors"
                            placeholder="Nh·∫≠p s·ªë CCCD ƒë·ªÉ mua b·∫£o hi·ªÉm" required>
                    </div>

                    <input type="text" id="cust-address"
                        class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:border-primary transition-colors"
                        placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán, t·ªânh/TP" required>
                </div>


                <button type="button" onclick="nextStep(2)"
                    class="w-full mt-6 bg-primary text-white font-bold text-lg py-4 rounded-2xl shadow-lg shadow-primary/30 hover:scale-[1.02] active:scale-95 transition-all">
                    Ti·∫øp t·ª•c: Kh·∫£o s√°t
                </button>
            </div>

            <!-- STEP 2: HEALTH & DIET -->
            <div id="step-2" class="step-content hidden animate__animated animate__fadeIn">
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 space-y-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
                        <i data-lucide="utensils" class="w-5 h-5 text-primary"></i> Kh·∫£o s√°t ƒÉn u·ªëng & Y√™u c·∫ßu
                    </h2>

                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-100">
                        <span class="font-bold text-gray-700 text-sm">B·∫°n c√≥ ƒÉn chay kh√¥ng?</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="diet-vegetarian" class="sr-only peer">
                            <div
                                class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary">
                            </div>
                        </label>
                    </div>

                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-100">
                        <span class="font-bold text-gray-700 text-sm">B·∫°n c√≥ mu·ªën m∆∞·ª£n g·∫≠y trekking kh√¥ng?</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="diet-trekking-pole" class="sr-only peer">
                            <div
                                class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary">
                            </div>
                        </label>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">B·∫°n c√≥ d·ªã ·ª©ng v·ªõi g√¨
                            kh√¥ng?</label>
                        <input type="text" id="diet-allergy"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:border-primary transition-colors"
                            placeholder="V√≠ d·ª•: H·∫£i s·∫£n, ƒë·∫≠u ph·ªông, ph·∫•n hoa...">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">B·∫°n c√≥ y√™u c·∫ßu ƒë·∫∑c bi·ªát g√¨
                            kh√¥ng?</label>
                        <textarea id="diet-special"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:border-primary transition-colors h-24 resize-none"
                            placeholder="V√≠ d·ª•: C·∫ßn h·ªó tr·ª£ xe ƒë∆∞a ƒë√≥n, thu√™ th√™m l·ªÅu ri√™ng..."></textarea>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">T√™n in tr√™n huy
                            ch∆∞∆°ng</label>
                        <input type="text" id="cust-medal-name"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:border-primary transition-colors"
                            placeholder="ƒê·ªÉ tr·ªëng n·∫øu gi·ªëng H·ªç t√™n">
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="button" onclick="nextStep(1)"
                        class="w-1/3 bg-gray-100 text-gray-600 font-bold text-lg py-4 rounded-2xl hover:bg-gray-200 transition-all">
                        Quay l·∫°i
                    </button>
                    <button type="button" onclick="nextStep(3)"
                        class="flex-1 bg-primary text-white font-bold text-lg py-4 rounded-2xl shadow-lg shadow-primary/30 hover:scale-[1.02] active:scale-95 transition-all">
                        Ti·∫øp t·ª•c: Cam k·∫øt
                    </button>
                </div>
            </div>

            <!-- STEP 3: WAIVERS -->
            <div id="step-3" class="step-content hidden animate__animated animate__fadeIn">
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 space-y-4">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i data-lucide="shield-check" class="w-5 h-5 text-primary"></i> Cam k·∫øt tham gia
                    </h2>

                    <div class="space-y-4">
                        <div class="flex items-start gap-3 p-3 bg-red-50 rounded-xl border border-red-100">
                            <input type="checkbox" id="commitment-health"
                                class="mt-1 w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary">
                            <label for="commitment-health"
                                class="text-sm text-gray-700 leading-snug cursor-pointer select-none font-medium">
                                T√¥i cam k·∫øt <span class="text-red-600 font-bold">KH√îNG</span> m·∫Øc c√°c b·ªánh li√™n quan ƒë·∫øn
                                ƒë∆∞·ªùng h√¥ h·∫•p, tim m·∫°ch, x∆∞∆°ng kh·ªõp v√† ho√†n to√†n t·ª± ch·ªãu tr√°ch nhi·ªám khi c√≥ v·∫•n ƒë·ªÅ s·ª©c
                                kh·ªèe li√™n quan x·∫£y ra trong chuy·∫øn ƒëi.
                            </label>
                        </div>

                        <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-xl border border-gray-100">
                            <input type="checkbox" id="commitment-waiver"
                                class="mt-1 w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary">
                            <label for="commitment-waiver"
                                class="text-sm text-gray-600 leading-snug cursor-pointer select-none">
                                T√¥i ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n <span class="font-bold">Mi·ªÖn tr·ª´ tr√°ch nhi·ªám</span> c·ªßa Cam
                                Site Retreats (kh√¥ng ch·ªãu tr√°ch nhi·ªám v·ªõi c√°c tai n·∫°n do l·ªói ch·ªß quan c√° nh√¢n).
                            </label>
                        </div>

                        <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-xl border border-gray-100">
                            <input type="checkbox" id="commitment-rules"
                                class="mt-1 w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary">
                            <label for="commitment-rules"
                                class="text-sm text-gray-600 leading-snug cursor-pointer select-none">
                                T√¥i cam k·∫øt <span class="font-bold">Tu√¢n th·ªß quy ƒë·ªãnh</span> c·ªßa ƒëo√†n, h∆∞·ªõng d·∫´n c·ªßa HDV
                                v√† gi·ªØ g√¨n v·ªá sinh m√¥i tr∆∞·ªùng.
                            </label>
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="button" onclick="nextStep(2)"
                        class="w-1/3 bg-gray-100 text-gray-600 font-bold text-lg py-4 rounded-2xl hover:bg-gray-200 transition-all">
                        Quay l·∫°i
                    </button>
                    <button type="button" onclick="nextStep(4)"
                        class="flex-1 bg-primary text-white font-bold text-lg py-4 rounded-2xl shadow-lg shadow-primary/30 hover:scale-[1.02] active:scale-95 transition-all">
                        Ti·∫øp t·ª•c: Thanh to√°n C·ªçc
                    </button>
                </div>
            </div>

            <!-- STEP 4: PAYMENT (DEPOSIT) -->
            <div id="step-4" class="step-content hidden animate__animated animate__fadeIn">
                <div class="bg-white rounded-2xl p-8 shadow-sm border border-gray-100 text-center">
                    <p class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-2">S·ªë ti·ªÅn c·ªçc c·∫ßn thanh to√°n
                    </p>
                    <div class="text-4xl font-black text-primary mb-2">1.000.000ƒë</div>
                    <p class="text-xs text-gray-500 italic mb-6">Vui l√≤ng chuy·ªÉn kho·∫£n ƒë·ªÉ gi·ªØ ch·ªó</p>

                    <div
                        class="bg-gray-50 p-6 rounded-xl border border-dashed border-gray-300 inline-block w-full max-w-sm mx-auto mb-6">
                        <!-- Dynamic QR Image -->
                        <div
                            class="w-52 h-52 bg-white mx-auto border-4 border-primary/20 rounded-2xl overflow-hidden flex items-center justify-center mb-4 shadow-inner">
                            <img id="deposit-qr" src="" alt="QR C·ªçc" class="w-full h-full object-contain">
                        </div>
                        <div class="text-left space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-500">Ng√¢n h√†ng:</span>
                                <span class="font-bold">BIDV</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">S·ªë t√†i kho·∫£n:</span>
                                <span class="font-bold text-lg text-primary tracking-wider">96247CAMSITERETREAT</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Ch·ªß t√†i kho·∫£n:</span>
                                <span class="font-bold uppercase">PHAM THIEN AN</span>
                            </div>
                            <div class="bg-primary/5 p-3 rounded-xl mt-4 border border-primary/10">
                                <span
                                    class="text-gray-500 text-[10px] font-bold uppercase tracking-wider block mb-1">N·ªôi
                                    dung chuy·ªÉn kho·∫£n</span>
                                <div class="flex items-center justify-between gap-2">
                                    <span class="font-bold text-primary font-mono break-all"
                                        id="transfer-content">...</span>
                                    <button onclick="copyContent()"
                                        class="bg-white p-2 rounded-lg shadow-sm border border-gray-100 text-gray-400 hover:text-primary transition-colors shrink-0">
                                        <i data-lucide="copy" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Listening Status -->
                    <div class="flex items-center justify-center gap-2 mb-4 text-sm text-gray-500"
                        id="deposit-listening">
                        <div
                            style="width:8px;height:8px;border-radius:50%;background:#22c55e;animation:pulse 1.5s infinite">
                        </div>
                        <span>ƒêang ch·ªù thanh to√°n... H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông x√°c nh·∫≠n</span>
                    </div>

                    <div class="flex gap-4">
                        <button type="button" onclick="nextStep(3)"
                            class="w-1/3 bg-gray-100 text-gray-600 font-bold text-lg py-4 rounded-2xl hover:bg-gray-200 transition-all">
                            Quay l·∫°i
                        </button>
                        <button type="button" onclick="confirmTransfer()"
                            class="flex-1 bg-green-600 text-white font-bold text-lg py-4 rounded-2xl shadow-lg shadow-green-600/30 hover:scale-[1.02] active:scale-95 transition-all">
                            X√°c nh·∫≠n ƒë√£ chuy·ªÉn kho·∫£n
                        </button>
                    </div>
                </div>
            </div>

        </form>

        <!-- SUCCESS SECTION (Hidden) -->
        <div id="success-section" class="hidden text-center py-10 animate__animated animate__fadeIn">
            <div
                class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 text-green-600">
                <i data-lucide="check" class="w-10 h-10 stroke-[3]"></i>
            </div>
            <h2 class="text-2xl font-black text-gray-800 mb-4">G·ª≠i x√°c nh·∫≠n th√†nh c√¥ng!</h2>
            <p class="text-gray-500 max-w-md mx-auto leading-relaxed mb-8">
                C·∫£m ∆°n b·∫°n ƒë√£ ho√†n t·∫•t th·ªß t·ª•c. Ch√∫ng t√¥i ƒë√£ nh·∫≠n ƒë∆∞·ª£c th√¥ng tin v√† s·∫Ω x√°c nh·∫≠n thanh to√°n trong v√≤ng
                1-2 gi·ªù l√†m vi·ªác.
            </p>
            <a href="../index.html"
                class="inline-block px-8 py-3 bg-gray-100 text-gray-600 font-bold rounded-xl hover:bg-gray-200 transition-all">
                V·ªÅ trang ch·ªß
            </a>
        </div>

    </main>

    <style>
        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1)
            }

            50% {
                opacity: .5;
                transform: scale(.8)
            }
        }

        @keyframes check-bounce {
            0% {
                transform: scale(0);
                opacity: 0
            }

            50% {
                transform: scale(1.2)
            }

            100% {
                transform: scale(1);
                opacity: 1
            }
        }

        .success-check {
            animation: check-bounce 0.6s ease-out forwards;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100px) rotate(0);
                opacity: 1
            }

            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0
            }
        }

        .confetti {
            position: fixed;
            top: -20px;
            animation: confetti-fall 3s ease-in forwards;
            pointer-events: none;
            z-index: 100;
        }
    </style>
    <script>
        lucide.createIcons();

        // 1. Initial Logic ‚Äî Load from URL params OR API
        const params = new URLSearchParams(window.location.search);
        const bookingDbId = params.get('id'); // New: booking ID from DB
        const leadData = {
            id: params.get('leadId') || bookingDbId || Date.now(),
            name: params.get('name') || '',
            phone: params.get('phone') || '',
            tour: params.get('tour') || '',
            date: params.get('date') || '',
            saleId: params.get('saleId') || null,
            saleName: params.get('saleName') || null
        };

        // If opened via ?id=XX, load data from API
        if (bookingDbId && !params.get('name')) {
            fetch(`../api/payment?action=link&id=${bookingDbId}`)
                .then(r => r.json())
                .then(data => {
                    leadData.name = data.name || '';
                    leadData.phone = data.phone || '';
                    leadData.tour = data.tour || '';
                    leadData.date = data.date || '';
                    document.getElementById('tour-name').value = leadData.tour;
                    document.getElementById('tour-date').value = leadData.date;
                    document.getElementById('cust-name').value = leadData.name;
                    document.getElementById('cust-phone').value = leadData.phone;
                    updateTransferContent();
                    updateDepositQR();
                })
                .catch(err => console.warn('API load error:', err));
        }

        // Populate Read-only Info
        document.getElementById('tour-name').value = leadData.tour;
        document.getElementById('tour-date').value = leadData.date;
        document.getElementById('cust-name').value = leadData.name;
        document.getElementById('cust-phone').value = leadData.phone;

        // Generate Transfer Code: tour date name coc (lowercase, no diacritics)
        let transferCode = '';
        function normalizeVN(str) {
            return (str || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/ƒë/gi, 'd').toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '').trim();
        }
        function updateTransferContent() {
            const cleanTour = normalizeVN((leadData.tour || 'Tour').split('-')[0].trim());
            const cleanDate = (leadData.date || '').replace(/\//g, '');
            const cleanName = normalizeVN(document.getElementById('cust-name').value || leadData.name || 'khach');
            transferCode = `${cleanTour} ${cleanDate} ${cleanName} coc`;
            document.getElementById('transfer-content').textContent = transferCode;
        }

        // Generate Dynamic QR
        function updateDepositQR() {
            const qrUrl = `https://qr.sepay.vn/img?acc=96247CAMSITERETREAT&bank=BIDV&amount=1000000&des=${encodeURIComponent(transferCode)}`;
            const qrImg = document.getElementById('deposit-qr');
            if (qrImg) qrImg.src = qrUrl;
        }

        updateTransferContent();
        updateDepositQR();

        function copyContent() {
            navigator.clipboard.writeText(transferCode).then(() => {
                alert('ƒê√£ copy n·ªôi dung chuy·ªÉn kho·∫£n!');
            }).catch(() => {
                prompt('Copy n·ªôi dung n√†y:', transferCode);
            });
        }

        // Confetti effect
        function showConfetti() {
            const colors = ['#E85D04', '#22c55e', '#3b82f6', '#f59e0b', '#ef4444'];
            for (let i = 0; i < 40; i++) {
                const el = document.createElement('div');
                el.className = 'confetti';
                el.style.left = Math.random() * 100 + 'vw';
                el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                el.style.width = (Math.random() * 10 + 5) + 'px';
                el.style.height = (Math.random() * 10 + 5) + 'px';
                el.style.borderRadius = Math.random() > .5 ? '50%' : '2px';
                el.style.animationDelay = (Math.random() * 2) + 's';
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 5000);
            }
        }

        // SePay Real-time Polling (starts at Step 4)
        let depositPollInterval = null;
        function startDepositPolling(bId) {
            if (depositPollInterval) return;
            depositPollInterval = setInterval(async () => {
                try {
                    const res = await fetch(`../api/payment?action=status&id=${bId}`);
                    const data = await res.json();
                    if (data.isPaid) {
                        clearInterval(depositPollInterval);
                        // Auto-show success!
                        document.getElementById('booking-form').classList.add('hidden');
                        document.getElementById('success-section').classList.remove('hidden');
                        showConfetti();
                        window.scrollTo(0, 0);
                    }
                } catch (err) { console.warn('Poll error:', err); }
            }, 5000);
        }

        // 2. Wizard Logic
        let currentStep = 1;

        function nextStep(step) {
            // Validation Logic
            if (step > currentStep) {
                if (!validateStep(currentStep)) return;
            }

            // Update UI
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step-${step}`).classList.remove('hidden');

            // Update Indicators
            document.querySelectorAll('.step-indicator div').forEach((el, index) => {
                if (index + 1 <= step) {
                    el.classList.remove('bg-white', 'text-gray-400', 'border-gray-300');
                    el.classList.add('bg-primary', 'text-white', 'border-primary');
                    el.nextElementSibling.classList.remove('text-gray-400');
                    el.nextElementSibling.classList.add('text-primary');
                } else {
                    el.classList.add('bg-white', 'text-gray-400', 'border-gray-300');
                    el.classList.remove('bg-primary', 'text-white', 'border-primary');
                    el.nextElementSibling.classList.add('text-gray-400');
                    el.nextElementSibling.classList.remove('text-primary');
                }
            });

            currentStep = step;
            window.scrollTo(0, 0);

            // When reaching Step 4: update transfer content with latest name + refresh QR
            if (step === 4) {
                updateTransferContent();
                updateDepositQR();
                // If we already have a DB booking ID, start polling right away
                if (bookingDbId) {
                    startDepositPolling(bookingDbId);
                }
            }
        }

        function validateStep(step) {
            if (step === 1) {
                const requiredIds = ['cust-name', 'cust-dob', 'cust-phone', 'cust-idcard', 'cust-address'];
                for (const id of requiredIds) {
                    const el = document.getElementById(id);
                    if (!el.value.trim()) {
                        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc (*)!');
                        el.focus();
                        return false;
                    }
                }
            }
            if (step === 3) {
                const requiredChecks = ['commitment-health', 'commitment-waiver', 'commitment-rules'];
                for (const id of requiredChecks) {
                    if (!document.getElementById(id).checked) {
                        alert('B·∫°n c·∫ßn ƒë·ªìng √Ω v·ªõi t·∫•t c·∫£ c√°c cam k·∫øt ƒë·ªÉ ti·∫øp t·ª•c!');
                        return false;
                    }
                }
            }
            return true;
        }

        // 3. Submit Logic
        async function confirmTransfer() {
            if (!confirm('B·∫°n ch·∫Øc ch·∫Øn ƒë√£ chuy·ªÉn kho·∫£n v√† mu·ªën ho√†n t·∫•t ƒëƒÉng k√Ω?')) return;

            // Gather Data
            const bookingData = {
                id: leadData.id,
                tour: leadData.tour,
                date: leadData.date,

                // Step 1: Personal
                name: document.getElementById('cust-name').value,
                phone: document.getElementById('cust-phone').value,
                dob: document.getElementById('cust-dob').value,
                gender: document.getElementById('cust-gender').value,
                idCard: document.getElementById('cust-idcard').value,
                address: document.getElementById('cust-address').value,
                medalName: document.getElementById('cust-medal-name').value || document.getElementById('cust-name').value,

                // Step 2: Health
                diet: document.getElementById('diet-vegetarian').checked ? 'ƒÇn chay' : 'Kh√¥ng',
                trekkingPole: document.getElementById('diet-trekking-pole').checked ? 'C√≥' : 'Kh√¥ng',
                allergy: document.getElementById('diet-allergy').value,
                special: document.getElementById('diet-special').value,

                // Step 3: Commitments (Implicitly true if submitted)
                commitments: true,

                // Step 4: Payment
                deposit: 1000000,
                totalPrice: (function () {
                    const tours = JSON.parse(localStorage.getItem('cam_site_tours')) || [];
                    const found = tours.find(t => t.name === leadData.tour);
                    return found ? Number(found.price) : 3200000;
                })(),
                status: 'Ch·ªù x√°c nh·∫≠n c·ªçc',

                // Sale Info (Preserved from Link)
                saleId: leadData.saleId,
                saleName: leadData.saleName,

                createdAt: new Date().toISOString()
            };

            // Save to LocalStorage (Legacy / Fallback)
            const BOOKINGS_KEY = 'cam_site_bookings';
            let bookings = JSON.parse(localStorage.getItem(BOOKINGS_KEY)) || [];
            bookings.push(bookingData);
            localStorage.setItem(BOOKINGS_KEY, JSON.stringify(bookings));

            // Sync to Server API
            const btn = document.querySelector('button[onclick="confirmTransfer()"]');
            const originalBtnText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto text-white"></i> ƒêang g·ª≠i...';
            lucide.createIcons();

            try {
                // Map fields to snake_case for DB
                const dbBooking = {
                    ...bookingData,
                    id_card: bookingData.idCard,
                    medal_name: bookingData.medalName,
                    total_price: bookingData.totalPrice,
                    sale_id: bookingData.saleId,
                    sale_name: bookingData.saleName,
                    trekking_pole: bookingData.trekkingPole
                };
                delete dbBooking.id; // Let DB generate Serial ID
                delete dbBooking.createdAt;

                const response = await fetch('../api/bookings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dbBooking)
                });

                if (response.ok) {
                    const savedBooking = await response.json();
                    console.log('Synced to Server:', savedBooking);
                    // Update local with DB ID if needed
                    bookings[bookings.length - 1].dbId = savedBooking.id;
                    localStorage.setItem(BOOKINGS_KEY, JSON.stringify(bookings));

                    // 1.2 Delete Lead from DB if exists
                    const leadId = params.get('leadId');
                    if (leadId) {
                        try {
                            await fetch(`../api/leads?id=${leadId}`, {
                                method: 'DELETE'
                            });
                            console.log('Lead deleted after conversion');
                        } catch (err) {
                            console.warn('Failed to delete lead:', err);
                        }
                    }

                    // Show Success only on positive API response
                    document.getElementById('booking-form').classList.add('hidden');
                    document.getElementById('success-section').classList.remove('hidden');
                    showConfetti();
                    window.scrollTo(0, 0);

                    // Start SePay polling (auto-detect payment)
                    if (savedBooking.id) {
                        startDepositPolling(savedBooking.id);
                    }

                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Server error');
                }
            } catch (err) {
                console.error('API Sync Error:', err);
                alert('C√≥ l·ªói x·∫£y ra khi n·ªôp ƒë∆°n: ' + err.message + '\nVui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† th·ª≠ l·∫°i, ho·∫∑c ch·ª•p m√†n h√¨nh l·ªói cho Admin.');
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
                lucide.createIcons();
                return; // Stop here
            }

            // Sync to Customer DB (Legacy / CRM local logic)
            try {
                const customerId = syncCustomerFromBooking(bookingData);
                if (customerId) {
                    const bks = JSON.parse(localStorage.getItem(BOOKINGS_KEY)) || [];
                    bks[bks.length - 1].customerId = customerId;
                    localStorage.setItem(BOOKINGS_KEY, JSON.stringify(bks));
                }
            } catch (e) {
                console.error('CRM Sync Error:', e);
            }
        }
    </script>
</body>

</html>