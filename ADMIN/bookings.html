<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đơn hàng chốt - CAM SITE RETREATS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="../js/auth.js"></script> <!-- Auth Logic -->
    <script src="../js/crm.js"></script> <!-- CRM Logic -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#E85D04',
                        secondary: '#FFF8F0',
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --primary: #E85D04;
            --bg-dashboard: #F8F9FA;
            --sidebar-width: 260px;
        }

        html {
            font-size: 18px;
        }

        @media (max-width: 768px) {
            html {
                font-size: 13px !important;
            }

            h1,
            h2,
            h3 {
                font-size: 15px !important;
                line-height: 1.4 !important;
            }
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-dashboard);
        }

        .sidebar {
            width: var(--sidebar-width);
            transition: all 0.3s ease;
        }

        .nav-link.active {
            background-color: rgba(232, 93, 4, 0.1);
            color: var(--primary);
            border-left: 4px solid var(--primary);
        }
    </style>
</head>

<body class="flex min-h-screen">

    <!-- Sidebar -->
    <aside class="sidebar fixed h-full bg-white border-r border-gray-100 flex flex-col z-40">
        <div class="p-6 border-b border-gray-100">
            <a href="../index.html" class="block">
                <img src="../logo.png" alt="CAM SITE RETREATS" class="h-14 w-auto object-contain">
                <span class="text-[10px] text-gray-400 block mt-1 font-bold uppercase tracking-widest">Admin
                    Panel</span>
            </a>
        </div>

        <nav class="flex-1 mt-6 px-4 space-y-2">
            <a href="dashboard.html"
                class="nav-link text-[15px] text-gray-500 hover:bg-gray-50 flex items-center space-x-3 p-3 rounded-xl font-medium transition-all group">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span>Tổng quan</span>
            </a>
            <a href="tours.html"
                class="nav-link text-[15px] text-gray-500 hover:bg-gray-50 flex items-center space-x-3 p-3 rounded-xl font-medium transition-all">
                <i data-lucide="package" class="w-5 h-5"></i>
                <span>Quản lý Tour</span>
            </a>
            <a href="schedules.html"
                class="nav-link text-[15px] text-gray-500 hover:bg-gray-50 flex items-center space-x-3 p-3 rounded-xl font-medium transition-all">
                <i data-lucide="calendar" class="w-5 h-5"></i>
                <span>Lịch trình Tour</span>
            </a>
            <a href="leads.html"
                class="nav-link text-[15px] text-gray-500 hover:bg-gray-50 flex items-center space-x-3 p-3 rounded-xl font-medium transition-all">
                <i data-lucide="message-square" class="w-5 h-5"></i>
                <span>Khách hàng đăng ký tư vấn</span>
                <span id="leads-badge-count" class="bg-primary text-white text-[10px] px-2 py-1 rounded-full ml-auto"
                    style="display: none;">0</span>
            </a>
            <a href="bookings.html"
                class="nav-link active flex items-center space-x-3 p-3 rounded-xl font-medium transition-all text-[15px]">
                <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                <span>Khách hàng đã đăng ký</span>
                <span id="bookings-badge-count"
                    class="bg-green-500 text-white text-[10px] px-2 py-1 rounded-full ml-auto"
                    style="display: none;">0</span>
            </a>
            <a href="users.html" id="nav-users"
                class="nav-link text-[15px] text-gray-500 hover:bg-gray-50 flex items-center space-x-3 p-3 rounded-xl font-medium transition-all">
                <i data-lucide="users-2" class="w-5 h-5"></i>
                <span>Quản lý User</span>
            </a>
            <a href="customers.html"
                class="nav-link text-[15px] text-gray-500 hover:bg-gray-50 flex items-center space-x-3 p-3 rounded-xl font-medium transition-all">
                <i data-lucide="users" class="w-5 h-5"></i>
                <span>Khách hàng</span>
            </a>
            <a href="reports.html"
                class="nav-link text-[15px] text-gray-500 hover:bg-gray-50 flex items-center space-x-3 p-3 rounded-xl font-medium transition-all">
                <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                <span>Báo cáo</span>
            </a>
        </nav>

        <div class="p-6 border-t border-gray-100">
            <div class="flex items-center gap-3 mb-4 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition-colors"
                onclick="window.location.href='profile.html'">
                <img id="sidebar-avatar" src="" class="w-8 h-8 rounded-full border border-gray-200">
                <div class="flex-1 min-w-0">
                    <p id="sidebar-name" class="text-xs font-bold text-gray-800 truncate">User</p>
                    <p id="sidebar-role" class="text-[10px] text-gray-500 uppercase">Role</p>
                </div>
            </div>
            <button onclick="logout()"
                class="w-full flex items-center space-x-3 p-3 rounded-xl font-medium text-red-500 hover:bg-red-50 transition-all">
                <i data-lucide="log-out" class="w-5 h-5"></i>
                <span>Đăng xuất</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 ml-[260px] p-8">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Khách hàng đã đăng ký</h1>
                <p class="text-gray-500 text-sm">Danh sách khách hàng đã hoàn thành đăng ký và thanh toán.</p>
            </div>
        </header>

        <!-- Filter Bar -->
        <div class="flex flex-col md:flex-row gap-4 mb-6">
            <div class="flex-1">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                    <input type="text" id="filter-search" oninput="loadBookings()"
                        class="w-full pl-10 pr-4 py-3 bg-white border border-gray-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all font-medium"
                        placeholder="Tìm kiếm tên, SĐT...">
                </div>
            </div>
            <div class="w-full md:w-48">
                <select id="filter-tour" onchange="onTourChange()"
                    class="w-full px-4 py-3 bg-white border border-gray-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 font-medium text-gray-600 appearance-none">
                    <option value="">Tất cả Tour</option>
                    <option value="Tà Năng - Phan Dũng">Tà Năng - Phan Dũng</option>
                    <option value="Tà Năng - Phan Dũng">Tà Năng - Phan Dũng</option>
                    <!-- Add more tours dynamically if needed -->
                </select>
            </div>

            <div class="w-full md:w-48">
                <select id="filter-sale" onchange="loadBookings()"
                    class="w-full px-4 py-3 bg-white border border-gray-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 font-medium text-gray-600 appearance-none">
                    <option value="">Tất cả Sale</option>
                </select>
            </div>

            <div class="w-full md:w-48">
                <select id="filter-status" onchange="loadBookings()"
                    class="w-full px-4 py-3 bg-white border border-gray-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 font-medium text-gray-600 appearance-none">
                    <option value="">Tất cả Trạng thái</option>
                    <option value="Chờ xác nhận cọc">Chờ xác nhận cọc</option>
                    <option value="Đã cọc (Chờ đi)">Đã cọc (Chờ đi)</option>
                    <option value="Hoàn tất">Hoàn tất</option>
                </select>
            </div>
            <div class="w-full md:w-auto">
                <select id="filter-date" onchange="loadBookings()"
                    class="w-full px-4 py-3 bg-white border border-gray-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 font-medium text-gray-600 appearance-none">
                    <option value="">Tất cả ngày</option>
                </select>
            </div>
            <button onclick="exportToExcel()"
                class="bg-green-100 text-green-700 px-6 py-3 rounded-xl font-bold flex items-center justify-center space-x-2 hover:bg-green-200 transition-all whitespace-nowrap">
                <i data-lucide="file-spreadsheet" class="w-5 h-5"></i>
                <span>Xuất Excel</span>
            </button>
        </div>

        <!-- Bookings Table -->
        <div class="bg-white rounded-[20px] shadow-sm border border-gray-100 overflow-hidden">
            <div
                class="p-6 border-b border-gray-100 bg-gray-50/10 text-gray-800 font-black uppercase tracking-tight text-primary underline decoration-primary/30 underline-offset-8">
                Khách hàng đã đăng ký
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse whitespace-nowrap">
                    <thead class="bg-gray-50/50 text-gray-400 text-[10px] uppercase tracking-widest">
                        <tr>
                            <th class="px-6 py-4 sticky left-0 bg-gray-50 z-10 shadow-sm border-r border-gray-100">Họ và
                                tên</th>
                            <th class="px-6 py-4">Tour / Ngày</th>
                            <th class="px-6 py-4">Người phụ trách</th>
                            <th class="px-6 py-4 text-center">Trạng thái</th>
                            <th class="px-6 py-4 text-right border-l border-gray-100">Tổng tiền</th>
                            <th class="px-6 py-4 text-right">Đã cọc</th>
                            <th class="px-6 py-4 text-right">Còn lại</th>
                            <th
                                class="px-6 py-4 text-right sticky right-0 bg-gray-50 z-10 shadow-sm border-l border-gray-100">
                                Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="bookings-table-body" class="divide-y divide-gray-50">
                        <!-- Dữ liệu được load động -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Edit Modal -->
    <div id="edit-modal"
        class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm transition-opacity duration-300">
        <div
            class="bg-white rounded-2xl p-8 w-full max-w-lg shadow-2xl transform scale-95 transition-transform duration-300 relative">
            <button onclick="closeEditModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <h2 class="text-xl font-bold text-gray-800 mb-6">Chỉnh sửa Đơn hàng</h2>

            <form onsubmit="saveEditBooking(event)" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                <input type="hidden" id="edit-id">

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Họ tên</label>
                        <input type="text" id="edit-name"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">SĐT</label>
                        <input type="text" id="edit-phone"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Tên in Huy chương</label>
                    <input type="text" id="edit-medal-name"
                        class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm text-primary font-bold">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Tour</label>
                        <input type="text" id="edit-tour"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm font-bold text-primary">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Ngày đi</label>
                        <input type="text" id="edit-date"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm font-mono">
                    </div>
                </div>

                <!-- New Info Fields for Edit -->
                <div class="grid grid-cols-2 gap-4 border-t border-gray-100 pt-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Ngày sinh</label>
                        <input type="date" id="edit-dob"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Giới tính</label>
                        <select id="edit-gender"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm">
                            <option value="Nam">Nam</option>
                            <option value="Nữ">Nữ</option>
                            <option value="Khác">Khác</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Mượn gậy trekking</label>
                        <select id="edit-trekking-pole"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm">
                            <option value="Không">Không</option>
                            <option value="Có">Có</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Ăn chay</label>
                        <select id="edit-diet"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm">
                            <option value="Không">Không</option>
                            <option value="Ăn chay">Ăn chay</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">CMND / Hộ chiếu</label>
                    <input type="text" id="edit-idcard"
                        class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Địa chỉ</label>
                    <input type="text" id="edit-address"
                        class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm">
                </div>

                <div class="grid grid-cols-2 gap-4 pt-2">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Dị ứng</label>
                        <input type="text" id="edit-allergy"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm"
                            placeholder="VD: Hải sản...">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Yêu cầu đặc biệt</label>
                        <input type="text" id="edit-special"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm">
                    </div>
                </div>

                <div class="flex items-center gap-2 pt-2 pb-2">
                    <input type="checkbox" id="edit-commitment"
                        class="w-4 h-4 text-primary rounded border-gray-300 focus:ring-primary">
                    <label for="edit-commitment" class="text-sm font-bold text-gray-700 select-none">Đã ký cam kết miễn
                        trừ trách nhiệm</label>
                </div>

                <div class="border-t border-gray-100 pt-4 grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Tổng tiền</label>
                        <input type="number" id="edit-total" oninput="updateRemainingCalculation()"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Đã cọc</label>
                        <input type="number" id="edit-deposit" oninput="updateRemainingCalculation()"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm font-bold text-green-600">
                    </div>
                </div>

                <div class="bg-red-50 p-3 rounded-lg flex justify-between items-center">
                    <span class="text-xs font-bold text-red-400 uppercase">Còn lại phải thu</span>
                    <span id="edit-remaining" class="text-lg font-black text-red-600">0đ</span>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeEditModal()"
                        class="flex-1 px-4 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition-colors">Hủy</button>
                    <button type="submit"
                        class="flex-1 px-4 py-3 bg-primary text-white rounded-xl font-bold shadow-lg shadow-primary/30 hover:scale-[1.02] active:scale-95 transition-all">Lưu
                        thay đổi</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        /* Modal Styles reused */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            width: 100%;
            max-width: 500px;
            padding: 40px;
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.1);
            animation: modalEnter 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes modalEnter {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>

    <script>
        lucide.createIcons();

        const BOOKINGS_KEY = 'cam_site_bookings';
        const LEADS_KEY = 'cam_site_leads';
        const SCHEDULES_KEY = 'cam_site_schedules';
        const TOURS_KEY = 'cam_site_tours';
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Check Auth
            currentUser = checkAuth();
            if (currentUser) {
                // Update Sidebar
                document.getElementById('sidebar-avatar').src = currentUser.avatar;
                document.getElementById('sidebar-name').textContent = currentUser.fullName;
                document.getElementById('sidebar-role').textContent = currentUser.role.toUpperCase();

                // Role Permissions
                if (currentUser.role !== 'admin') {
                    document.getElementById('nav-users').classList.add('hidden');
                }
            }

            loadTourOptions();
            loadDateOptions();
            loadTourOptions(); // Duplicate call in original, keeping structure
            loadDateOptions(); // Duplicate call in original, keeping structure

            // Migration: Fix legacy 3.2M prices
            migrateLegacyPrices();

            loadBookings();
        });

        function loadTourOptions() {
            const tourSelect = document.getElementById('filter-tour');
            const currentVal = tourSelect.value;
            const tours = JSON.parse(localStorage.getItem(TOURS_KEY)) || [];

            // Reset Options but keep "All Tours"
            tourSelect.innerHTML = '<option value="">Tất cả Tour</option>';

            tours.forEach(tour => {
                const option = document.createElement('option');
                option.value = tour.name;
                option.textContent = tour.name;
                tourSelect.appendChild(option);
            });

            // Restore selection if valid
            if (tours.some(t => t.name === currentVal)) {
                tourSelect.value = currentVal;
            }
        }

        function loadBookings() {
            const bookings = JSON.parse(localStorage.getItem(BOOKINGS_KEY)) || [];
            updateSaleFilterOptions(bookings);
            renderBookings(bookings);
            updateBadges();
        }

        function updateSaleFilterOptions(bookings) {
            const saleSelect = document.getElementById('filter-sale');
            if (!saleSelect) return;

            const currentVal = saleSelect.value;
            const sales = new Set();

            bookings.forEach(b => {
                if (b.saleName) sales.add(JSON.stringify({ id: b.saleId, name: b.saleName }));
            });

            saleSelect.innerHTML = '<option value="">Tất cả Sale</option>';

            sales.forEach(s => {
                const saleObj = JSON.parse(s);
                const option = document.createElement('option');
                option.value = saleObj.id;
                option.textContent = saleObj.name;
                saleSelect.appendChild(option);
            });

            saleSelect.value = currentVal;
        }

        function migrateLegacyPrices() {
            let bookings = JSON.parse(localStorage.getItem(BOOKINGS_KEY)) || [];
            const tours = JSON.parse(localStorage.getItem(TOURS_KEY)) || [];
            let changed = false;

            bookings = bookings.map(b => {
                // If price is exactly 3200000 (old default) OR missing
                if (!b.totalPrice || Number(b.totalPrice) === 3200000) {
                    const t = tours.find(tour => tour.name === b.tour);
                    if (t && Number(t.price) !== 3200000) {
                        b.totalPrice = Number(t.price);
                        changed = true;
                    }
                }
                return b;
            });

            if (changed) {
                localStorage.setItem(BOOKINGS_KEY, JSON.stringify(bookings));
                console.log('Migrated legacy prices to match Tour DB.');
            }
        }

        // --- Date Filter Logic ---
        function onTourChange() {
            loadDateOptions();
            loadBookings();
        }

        function loadDateOptions() {
            const tourFilter = document.getElementById('filter-tour').value;
            const dateSelect = document.getElementById('filter-date');
            const currentVal = dateSelect.value;

            // Get Schedules
            const schedules = JSON.parse(localStorage.getItem(SCHEDULES_KEY)) || [];

            let validSchedules = schedules;
            if (tourFilter) {
                validSchedules = schedules.filter(s => s.tour === tourFilter);
            }

            // De-duplicate by Short Date Label to avoid duplicates in dropdown
            const uniqueOptions = [];
            const seen = new Set();

            validSchedules.forEach(s => {
                if (!s.startDate || !s.endDate) return;

                // Format: DD/MM (Shortened as requested)
                const d1 = new Date(s.startDate);
                const d2 = new Date(s.endDate);

                const f1 = `${d1.getDate().toString().padStart(2, '0')}/${(d1.getMonth() + 1).toString().padStart(2, '0')}`;
                const f2 = `${d2.getDate().toString().padStart(2, '0')}/${(d2.getMonth() + 1).toString().padStart(2, '0')}`;

                const label = `${f1} - ${f2}`; // "15/03 - 16/03" 

                if (seen.has(s.startDate)) return;
                seen.add(s.startDate);

                uniqueOptions.push({
                    value: s.startDate,
                    label: label,
                    fullLabel: s.startDate
                });
            });

            // Sort by date
            uniqueOptions.sort((a, b) => a.fullLabel.localeCompare(b.fullLabel));

            // Build Options
            dateSelect.innerHTML = '<option value="">Tất cả ngày</option>';
            uniqueOptions.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.label;
                dateSelect.appendChild(option);
            });

            // Restore selection if still valid, otherwise reset
            if (uniqueOptions.some(o => o.value === currentVal)) {
                dateSelect.value = currentVal;
            } else {
                dateSelect.value = "";
            }
        }

        let currentFilteredBookings = [];

        function renderBookings(bookings) {
            // --- FILTER LOGIC ---
            const searchTerm = document.getElementById('filter-search')?.value.toLowerCase() || '';
            const filterTour = document.getElementById('filter-tour')?.value || '';
            const filterStatus = document.getElementById('filter-status')?.value || '';
            const filterDateStart = document.getElementById('filter-date')?.value || ''; // This is YYYY-MM-DD start date
            const filterSale = document.getElementById('filter-sale')?.value || '';

            // Prepare Matchers
            // We need to match against what's actually in booking.date.
            // booking.date could be "15/3/2026 - 16/3/2026" or "15/03/2026 - 16/03/2026"
            // or maybe "15/3 - 16/3" if user manually entered it.

            let possibleMatches = [];
            const filterDateParts = filterDateStart ? filterDateStart.split('|') : [];
            const hasCompositeDate = filterDateParts.length === 2;

            if (filterDateStart) {
                // Determine Start and End dates for matching
                let startDateVal, endDateVal;

                if (hasCompositeDate) {
                    startDateVal = filterDateParts[0];
                    endDateVal = filterDateParts[1];
                } else {
                    // Fallback for legacy single value
                    startDateVal = filterDateStart;
                    const schedules = JSON.parse(localStorage.getItem(SCHEDULES_KEY)) || [];
                    const sched = schedules.find(s => s.startDate === startDateVal && (!filterTour || s.tour === filterTour));
                    if (sched) endDateVal = sched.endDate;
                }

                possibleMatches.push(startDateVal); // Match raw YYYY-MM-DD

                if (endDateVal && startDateVal) {
                    const d1 = new Date(startDateVal);
                    const d2 = new Date(endDateVal);

                    // Variants for "DD/MM - DD/MM" logic
                    // 1. Strict label format: 15/03 - 16/03
                    const f1 = `${d1.getDate().toString().padStart(2, '0')}/${(d1.getMonth() + 1).toString().padStart(2, '0')}`;
                    const f2 = `${d2.getDate().toString().padStart(2, '0')}/${(d2.getMonth() + 1).toString().padStart(2, '0')}`;
                    possibleMatches.push(`${f1} - ${f2}`); // "15/03 - 16/03"

                    // 2. Short format: 15/3 - 16/3
                    const f1_s = `${d1.getDate()}/${d1.getMonth() + 1}`;
                    const f2_s = `${d2.getDate()}/${d2.getMonth() + 1}`;
                    possibleMatches.push(`${f1_s} - ${f2_s}`); // "15/3 - 16/3"

                    // 3. Mixed format? Just in case
                    possibleMatches.push(`${f1} - ${f2_s}`);
                    possibleMatches.push(`${f1_s} - ${f2}`);

                    // 4. Also match just the Start Date string for loose matching if strict fails
                    possibleMatches.push(f1);
                    possibleMatches.push(f1_s);
                }
            }

            currentFilteredBookings = bookings.filter(b => {
                const matchesSearch = (b.name?.toLowerCase().includes(searchTerm) || b.phone?.includes(searchTerm));
                const matchesTour = filterTour ? b.tour === filterTour : true;
                const matchesStatus = filterStatus ? b.status === filterStatus : true;

                let matchesSale = true;
                if (filterSale) {
                    matchesSale = b.saleId == filterSale;
                }

                let matchesDate = true;
                if (filterDateStart) {
                    const bDate = (b.date || '').trim();
                    // Check if booking date *starts with* or *contains* any of the possible start date versions
                    matchesDate = possibleMatches.some(m => bDate.includes(m));
                }

                return matchesSearch && matchesTour && matchesStatus && matchesDate && matchesSale;
            });

            const tableBody = document.getElementById('bookings-table-body');
            tableBody.innerHTML = '';

            if (currentFilteredBookings.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-10 text-center text-gray-400 italic text-sm">Không tìm thấy đơn hàng nào phù hợp.</td></tr>';
                return;
            }

            // Sort logic (Newest first)
            currentFilteredBookings.sort((a, b) => b.id - a.id);

            currentFilteredBookings.forEach(booking => {
                const date = new Date(booking.createdAt || booking.id);
                const initial = booking.name.charAt(0).toUpperCase();

                // Money
                // Find Tour Price from DB if not saved in booking
                const tours = JSON.parse(localStorage.getItem(TOURS_KEY)) || [];
                const tourData = tours.find(t => t.name === booking.tour);
                const defaultPrice = tourData ? Number(tourData.price) : 0;

                const total = Number(booking.totalPrice) || defaultPrice;
                const deposit = Number(booking.deposit) || 0;
                const remaining = total - deposit;
                const fmt = (n) => n.toLocaleString('vi-VN') + 'đ';

                // Status Badge
                let statusClass = 'bg-gray-100 text-gray-600';
                if (booking.status === 'Chờ xác nhận cọc') statusClass = 'bg-yellow-100 text-yellow-700';
                if (booking.status === 'Đã cọc (Chờ đi)') statusClass = 'bg-blue-100 text-blue-700';
                if (booking.status === 'Hoàn tất') statusClass = 'bg-green-100 text-green-700';

                // --- BUILD NOTES TAGS ---
                let notesHtml = '';

                // Vegeterian Tag
                if (booking.diet === 'Ăn chay') {
                    notesHtml += `<span class="inline-flex items-center gap-1 rounded px-1.5 py-0.5 text-[10px] font-bold bg-green-50 text-green-600 border border-green-100 mr-1 mb-1">
                        <i data-lucide="leaf" class="w-3 h-3"></i> Ăn chay
                    </span>`;
                }

                // Trekking Pole Tag
                if (booking.trekkingPole === 'Có') {
                    notesHtml += `<span class="inline-flex items-center gap-1 rounded px-1.5 py-0.5 text-[10px] font-bold bg-blue-50 text-blue-600 border border-blue-100 mr-1 mb-1">
                        <i data-lucide="person-standing" class="w-3 h-3"></i> Gậy
                    </span>`;
                }

                // Allergy (Only if has value)
                if (booking.allergy) {
                    notesHtml += `<div class="text-[11px] text-red-500 font-medium mt-1 truncate" title="Dị ứng: ${booking.allergy}">
                        • Dị ứng: ${booking.allergy}
                     </div>`;
                }

                // Special Request (Only if has value)
                if (booking.special) {
                    notesHtml += `<div class="text-[11px] text-gray-500 italic mt-0.5 truncate max-w-[200px]" title="Note: ${booking.special}">
                        • Note: ${booking.special}
                     </div>`;
                }

                if (!notesHtml) notesHtml = '<span class="text-gray-300 text-xs">-</span>';

                const row = `
                    <tr class="hover:bg-gray-50/50 transition-colors text-sm group">
                        <!-- Customer Name (Sticky Left) -->
                        <td class="px-6 py-4 sticky left-0 bg-white group-hover:bg-gray-50/50 z-10 border-r border-gray-100 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">
                             <div class="font-bold text-gray-800">${booking.name}</div>
                        </td>

                        <!-- Tour Info -->
                        <td class="px-6 py-4">
                             <div class="font-bold text-gray-700">${booking.tour}</div>
                             <div class="text-[10px] text-primary italic font-medium">${booking.date || 'Chưa chọn'}</div>
                        </td>

                        <!-- Sale Info -->
                        <td class="px-6 py-4">
                            ${booking.saleName ?
                        `<div class="flex items-center space-x-2">
                                    <div class="w-5 h-5 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 text-[10px] font-bold">
                                        ${booking.saleName.charAt(0)}
                                    </div>
                                    <span class="text-xs font-bold text-gray-700">${booking.saleName}</span>
                                </div>` :
                        '<span class="text-xs text-gray-400 italic">--</span>'}
                        </td>

                        <!-- Status -->
                        <td class="px-6 py-4 text-center">
                            <span class="${statusClass} text-[10px] px-2 py-1 rounded-full font-bold uppercase tracking-widest block w-fit mx-auto whitespace-nowrap">
                                ${booking.status}
                            </span>
                        </td>

                        <!-- Payment -->
                        <td class="px-6 py-4 text-right border-l border-gray-100 font-bold text-gray-800">${fmt(total)}</td>
                        <td class="px-6 py-4 text-right font-bold text-green-600">${fmt(deposit)}</td>
                        <td class="px-6 py-4 text-right font-bold text-red-500">${fmt(remaining)}</td>

                        <!-- Actions (Sticky Right) -->
                        <td class="px-6 py-4 text-right sticky right-0 bg-white group-hover:bg-gray-50/50 z-10 border-l border-gray-100 shadow-[-2px_0_5px_-2px_rgba(0,0,0,0.05)]">
                             <div class="flex items-center justify-end space-x-2">
                                ${booking.status === 'Chờ xác nhận cọc' ? `
                                <button onclick="confirmDeposit(${booking.id})" class="bg-primary text-white p-2 rounded-lg hover:shadow-lg hover:bg-orange-600 transition-all" title="Xác nhận cọc">
                                    <i data-lucide="check" class="w-4 h-4"></i>
                                </button>` : ''}
                                
                                <button onclick="copyPaymentLink(${booking.id})" class="text-blue-500 hover:bg-blue-50 p-2 rounded-lg transition-colors" title="Copy Link Payment">
                                    <i data-lucide="credit-card" class="w-4 h-4"></i>
                                </button>
                                
                                <button onclick="openEditModal('${booking.id}')" class="text-gray-500 hover:bg-gray-100 p-2 rounded-lg transition-colors" title="Sửa">
                                    <i data-lucide="pencil" class="w-4 h-4"></i>
                                </button>

                                ${(currentUser && currentUser.role === 'admin') ? `
                                <button onclick="deleteBooking(${booking.id})" class="text-gray-300 hover:text-red-500 transition-colors p-2" title="Xóa">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
            lucide.createIcons();
        }

        function updateBadges() {
            // Update Bookings Badge
            const bookings = JSON.parse(localStorage.getItem(BOOKINGS_KEY)) || [];
            const bookingsBadge = document.getElementById('bookings-badge-count');
            if (bookingsBadge) {
                bookingsBadge.textContent = bookings.length;
                bookingsBadge.style.display = bookings.length > 0 ? 'inline-block' : 'none';
            }

            // Update Leads Badge
            const leads = JSON.parse(localStorage.getItem(LEADS_KEY)) || [];
            const pendingLeads = leads.filter(l => l.status === 'Chờ tư vấn').length;
            const leadsBadge = document.getElementById('leads-badge-count');
            if (leadsBadge) {
                leadsBadge.textContent = pendingLeads;
                leadsBadge.style.display = pendingLeads > 0 ? 'inline-block' : 'none';
            }
        }

        function confirmDeposit(id) {
            if (!confirm('Xác nhận đã nhận 500.000đ tiền cọc từ khách hàng này?')) return;

            let bookings = JSON.parse(localStorage.getItem(BOOKINGS_KEY)) || [];
            bookings = bookings.map(b => {
                if (b.id == id) {
                    b.status = 'Đã cọc (Chờ đi)';
                }
                return b;
            });
            localStorage.setItem(BOOKINGS_KEY, JSON.stringify(bookings));
            loadBookings();
        }

        function copyPaymentLink(id) {
            let bookings = JSON.parse(localStorage.getItem(BOOKINGS_KEY)) || [];
            const booking = bookings.find(b => b.id == id);

            if (booking) {
                const tours = JSON.parse(localStorage.getItem(TOURS_KEY)) || [];
                const tourData = tours.find(t => t.name === booking.tour);
                const defaultPrice = tourData ? Number(tourData.price) : 0;

                const total = Number(booking.totalPrice) || defaultPrice;
                const deposit = Number(booking.deposit) || 0;
                const remaining = total - deposit;

                const data = {
                    i: booking.id,
                    n: booking.name,
                    t: booking.tour,
                    r: remaining
                };

                const jsonStr = JSON.stringify(data);

                // Use UTF-8 safe encoding for Base64
                const token = btoa(encodeURIComponent(jsonStr).replace(/%([0-9A-F]{2})/g,
                    function toSolidBytes(match, p1) {
                        return String.fromCharCode('0x' + p1);
                    }));

                // Use URL API for relative path (works with any casing of /ADMIN/)
                // Assuming current page is .../ADMIN/bookings.html, target is .../booking/payment.html
                const url = new URL('../booking/payment.html', window.location.href).href + '?code=' + token;

                navigator.clipboard.writeText(url)
                    .then(() => {
                        alert(`✅ Đã copy Link rút gọn!\n\nLink: ${url}`);
                    })
                    .catch(err => {
                        console.error('Clipboard failed', err);
                        prompt("Không thể tự động copy (Do trình duyệt chặn). Vui lòng copy link dưới đây:", url);
                    });
            }
        }

        function deleteBooking(id) {
            if (!confirm('Bạn có chắc muốn xóa khách hàng đã đăng ký này?')) return;
            let bookings = JSON.parse(localStorage.getItem(BOOKINGS_KEY)) || [];
            bookings = bookings.filter(b => b.id != id);
            localStorage.setItem(BOOKINGS_KEY, JSON.stringify(bookings));
            loadBookings();
        }

        function exportToExcel() {
            if (currentFilteredBookings.length === 0) {
                alert('Không có dữ liệu để xuất!');
                return;
            }

            // Headers matches the columns visible in table
            let csvContent = "data:text/csv;charset=utf-8,";

            // Add BOM for Vietnamese characters
            csvContent += "\uFEFF";

            // CSV Header
            csvContent += "ID,Khach Hang,SDT,Tour,Ngay Di,Trang Thai,Ghi Chu & Yeu Cau,Tong Tien,Da Coc,Con Lai\r\n";

            currentFilteredBookings.forEach(b => {
                // Build Note String
                let noteParts = [];
                if (b.diet === 'Ăn chay') noteParts.push('Ăn chay');
                if (b.trekkingPole === 'Có') noteParts.push('Mượn gậy');
                if (b.allergy) noteParts.push(`Dị ứng: ${b.allergy}`);
                if (b.special) noteParts.push(`Note: ${b.special}`);

                // Sanitize string to prevent CSV break (remove commas)
                const sanitize = (str) => str ? str.toString().replace(/,/g, ' ') : '';

                const row = [
                    `#B${getShortId(b.id)}`,
                    sanitize(b.name),
                    `'${sanitize(b.phone)}`, // ' to force string in Excel
                    sanitize(b.tour),
                    sanitize(b.date),
                    sanitize(b.status),
                    sanitize(noteParts.join('; ')), // Combine notes
                    b.totalPrice,
                    b.deposit,
                    Number(b.totalPrice) - Number(b.deposit)
                ];

                csvContent += row.join(",") + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `bookings_export_${new Date().getTime()}.csv`);
            document.body.appendChild(link); // Required for FF
            link.click();
            document.body.removeChild(link);
        }

        // --- Utils & Edit Logic ---

        function getShortId(id) {
            return id.toString().slice(-6);
        }

        function openEditModal(id) {
            const bookings = JSON.parse(localStorage.getItem(BOOKINGS_KEY)) || [];
            const booking = bookings.find(b => b.id == id);
            if (!booking) return;

            // Basic Info
            document.getElementById('edit-id').value = booking.id;
            document.getElementById('edit-name').value = booking.name;
            document.getElementById('edit-phone').value = booking.phone;
            document.getElementById('edit-tour').value = booking.tour;
            document.getElementById('edit-date').value = booking.date || '';

            // Extended Info
            document.getElementById('edit-dob').value = booking.dob || '';
            document.getElementById('edit-gender').value = booking.gender || 'Nam';
            document.getElementById('edit-idcard').value = booking.idCard || '';
            document.getElementById('edit-address').value = booking.address || '';
            document.getElementById('edit-trekking-pole').value = booking.trekkingPole || 'Không';

            // New Fields
            document.getElementById('edit-medal-name').value = booking.medalName || booking.name || '';
            document.getElementById('edit-diet').value = booking.diet || 'Không';
            document.getElementById('edit-allergy').value = booking.allergy || '';
            document.getElementById('edit-special').value = booking.special || '';
            document.getElementById('edit-commitment').checked = !!booking.commitments;

            // Money
            const tours = JSON.parse(localStorage.getItem(TOURS_KEY)) || [];
            const tourData = tours.find(t => t.name === booking.tour);
            const defaultPrice = tourData ? Number(tourData.price) : 0;

            document.getElementById('edit-total').value = Number(booking.totalPrice) || defaultPrice;
            document.getElementById('edit-deposit').value = Number(booking.deposit) || 0;

            updateRemainingCalculation();

            const modal = document.getElementById('edit-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            lucide.createIcons();
        }

        function closeEditModal() {
            const modal = document.getElementById('edit-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function updateRemainingCalculation() {
            const total = Number(document.getElementById('edit-total').value) || 0;
            const deposit = Number(document.getElementById('edit-deposit').value) || 0;
            const remaining = total - deposit;
            document.getElementById('edit-remaining').textContent = remaining.toLocaleString('vi-VN') + 'đ';
        }

        function saveEditBooking(e) {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('edit-name').value;
            const phone = document.getElementById('edit-phone').value;
            const tour = document.getElementById('edit-tour').value;
            const date = document.getElementById('edit-date').value;
            const total = Number(document.getElementById('edit-total').value);
            const deposit = Number(document.getElementById('edit-deposit').value);

            let bookings = JSON.parse(localStorage.getItem(BOOKINGS_KEY)) || [];
            const index = bookings.findIndex(b => b.id == id);

            if (index !== -1) {
                bookings[index].name = name;
                bookings[index].phone = phone;
                bookings[index].tour = tour;
                bookings[index].date = date;

                // Existing + New Fields
                bookings[index].dob = document.getElementById('edit-dob').value;
                bookings[index].gender = document.getElementById('edit-gender').value;
                bookings[index].idCard = document.getElementById('edit-idcard').value;
                bookings[index].address = document.getElementById('edit-address').value;
                bookings[index].trekkingPole = document.getElementById('edit-trekking-pole').value;

                bookings[index].medalName = document.getElementById('edit-medal-name').value;
                bookings[index].diet = document.getElementById('edit-diet').value;
                bookings[index].allergy = document.getElementById('edit-allergy').value;
                bookings[index].special = document.getElementById('edit-special').value;
                bookings[index].commitments = document.getElementById('edit-commitment').checked;

                bookings[index].totalPrice = total;
                bookings[index].deposit = deposit;

                // Auto update status if fully paid? (Optional, skipping to avoid side effects)
                if (total > 0 && deposit >= total && bookings[index].status === 'Đã cọc (Chờ đi)') {
                    bookings[index].status = 'Hoàn tất';
                }

                localStorage.setItem(BOOKINGS_KEY, JSON.stringify(bookings));

                alert('Đã cập nhật đơn hàng thành công!');
                closeEditModal();
                loadBookings();
            }
        }


    </script>
</body>

</html>