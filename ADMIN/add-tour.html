<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫°o Tour M·ªõi | CAM SITE RETREATS Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Lexend', sans-serif;
            background-color: #f8fafc;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .bg-primary {
            background-color: #FF5A1F;
        }

        .text-primary {
            color: #FF5A1F;
        }

        .border-primary {
            border-color: #FF5A1F;
        }

        .step-dot.active {
            background-color: #FF5A1F;
            border-color: #FF5A1F;
            color: white;
        }

        .step-dot.completed {
            background-color: #10b981;
            border-color: #10b981;
            color: white;
        }
    </style>
</head>

<body class="min-h-screen pb-24">
    <nav class="bg-white border-b border-gray-100 sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <a href="/ADMIN/tours.html" class="p-2 hover:bg-gray-50 rounded-lg transition-all">
                    <i data-lucide="arrow-left" class="w-6 h-6 text-gray-500"></i>
                </a>
                <h1 class="text-xl font-bold text-gray-800">T·∫°o H√†nh Tr√¨nh M·ªõi</h1>
            </div>
            <div class="flex items-center space-x-2">
                <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Tr·∫°ng th√°i:</span>
                <span
                    class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-[10px] font-bold uppercase">Nh√°p</span>
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto px-6 mt-8">
        <!-- Stepper -->
        <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100 mb-8">
            <div class="flex items-center justify-between relative">
                <div class="absolute top-1/2 left-0 w-full h-0.5 bg-gray-100 -translate-y-1/2 z-0"></div>

                <div class="relative z-10 flex flex-col items-center group">
                    <div id="dot-1"
                        class="step-dot active w-10 h-10 rounded-full border-2 border-gray-200 bg-white flex items-center justify-center font-bold text-sm transition-all">
                        1</div>
                    <span class="text-[10px] font-bold mt-2 text-gray-400 uppercase">C∆° b·∫£n</span>
                </div>

                <div class="relative z-10 flex flex-col items-center">
                    <div id="dot-2"
                        class="step-dot w-10 h-10 rounded-full border-2 border-gray-200 bg-white flex items-center justify-center font-bold text-sm transition-all">
                        2</div>
                    <span class="text-[10px] font-bold mt-2 text-gray-400 uppercase">Media</span>
                </div>

                <div class="relative z-10 flex flex-col items-center">
                    <div id="dot-3"
                        class="step-dot w-10 h-10 rounded-full border-2 border-gray-200 bg-white flex items-center justify-center font-bold text-sm transition-all">
                        3</div>
                    <span class="text-[10px] font-bold mt-2 text-gray-400 uppercase">Th√¥ng s·ªë</span>
                </div>

                <div class="relative z-10 flex flex-col items-center">
                    <div id="dot-4"
                        class="step-dot w-10 h-10 rounded-full border-2 border-gray-200 bg-white flex items-center justify-center font-bold text-sm transition-all">
                        4</div>
                    <span class="text-[10px] font-bold mt-2 text-gray-400 uppercase">Ph·ª• l·ª•c</span>
                </div>
            </div>
        </div>

        <form id="addTourForm" onsubmit="saveTour(event)" novalidate>
            <input type="hidden" id="edit-id">

            <!-- Step 1: Basic Info -->
            <section id="step-1" class="step-content active space-y-6">
                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                        <i data-lucide="info" class="w-5 h-5 mr-3 text-primary"></i>
                        Th√¥ng tin ƒë·ªãnh danh
                    </h3>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="col-span-2">
                            <label class="block text-sm font-bold text-gray-700 mb-2">T√™n Tour</label>
                            <input type="text" id="tour-name" placeholder="VD: T√† NƒÉng Phan D≈©ng"
                                class="w-full px-4 py-3 rounded-xl border border-gray-100 focus:border-primary outline-none transition-all">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-sm font-bold text-gray-700 mb-2">Slug (ƒê∆∞·ªùng d·∫´n)</label>
                            <input type="text" id="tour-slug" placeholder="ta-nang-phan-dung"
                                class="w-full px-4 py-3 rounded-xl border border-gray-100 bg-gray-50 font-mono text-xs">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-sm font-bold text-gray-700 mb-2">Gi√° Tour (VNƒê)</label>
                            <input type="number" id="tour-price" placeholder="2800000"
                                class="w-full px-4 py-3 rounded-xl border border-gray-100 focus:border-primary outline-none transition-all font-bold text-primary">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-sm font-bold text-gray-700 mb-2">V√πng Mi·ªÅn</label>
                            <select id="tour-region"
                                class="w-full px-4 py-3 rounded-xl border border-gray-100 outline-none">
                                <option>Mi·ªÅn Nam</option>
                                <option>Mi·ªÅn Trung</option>
                                <option>Mi·ªÅn B·∫Øc</option>
                                <option>T√¢y Nguy√™n</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label class="block text-sm font-bold text-gray-700 mb-2">Lo·∫°i H√¨nh</label>
                            <select id="tour-type"
                                class="w-full px-4 py-3 rounded-xl border border-gray-100 outline-none">
                                <option>TREKKING</option>
                                <option>HIKING</option>
                                <option>CAMPING</option>
                                <option>CYCLING</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label class="block text-sm font-bold text-gray-700 mb-2">Th·ªùi gian</label>
                            <input type="text" id="tour-duration-top" placeholder="2 ng√†y 1 ƒë√™m"
                                class="w-full px-4 py-3 rounded-xl border border-gray-100 focus:border-primary outline-none transition-all">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-sm font-bold text-gray-700 mb-2">ƒê·ªô cao (L√™n t·ªõi)</label>
                            <input type="text" id="tour-altitude-top" placeholder="1100m"
                                class="w-full px-4 py-3 rounded-xl border border-gray-100 focus:border-primary outline-none transition-all">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-sm font-bold text-gray-700 mb-2">C·∫•p ƒë·ªô k·ªπ thu·∫≠t</label>
                            <select id="tour-level-top"
                                class="w-full px-4 py-3 rounded-xl border border-gray-100 outline-none">
                                <option>C∆° b·∫£n</option>
                                <option>Trung b√¨nh</option>
                                <option>Th√°ch th·ª©c</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                        <i data-lucide="align-left" class="w-5 h-5 mr-3 text-primary"></i>
                        M√¥ t·∫£ t√≥m t·∫Øt
                    </h3>
                    <textarea id="tour-short-desc" rows="4" placeholder="Vi·∫øt m√¥ t·∫£ ng·∫Øn g·ªçn thu h√∫t kh√°ch h√†ng..."
                        class="w-full px-4 py-3 rounded-xl border border-gray-100 focus:border-primary outline-none transition-all"></textarea>
                </div>
            </section>

            <!-- Step 2: Media -->
            <section id="step-2" class="step-content space-y-6">
                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                        <i data-lucide="image" class="w-5 h-5 mr-3 text-primary"></i>
                        ·∫¢nh b√¨a chi ti·∫øt (Social Preview)
                    </h3>
                    <div class="space-y-4">
                        <input type="text" id="tour-hero-image" placeholder="https://example.com/hero.jpg"
                            class="w-full px-4 py-3 rounded-xl border border-gray-100 focus:border-primary outline-none transition-all">
                        <p class="text-[10px] text-gray-400 italic">D√πng l√†m h√¨nh ·∫£nh hi·ªÉn th·ªã khi chia s·∫ª link l√™n
                            Facebook/Zalo v√† ·∫£nh b√¨a trang chi ti·∫øt.</p>
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center justify-between">
                        <div class="flex items-center">
                            <i data-lucide="images" class="w-5 h-5 mr-3 text-primary"></i>
                            ·∫¢nh Slideshow s·∫£n ph·∫©m
                        </div>
                        <button type="button" onclick="addImageField('card-slideshow-container')"
                            class="text-primary hover:bg-primary/5 px-3 py-1 rounded-lg text-xs font-bold border border-primary/20 transition-all">+
                            Th√™m ·∫£nh</button>
                    </h3>
                    <div id="card-slideshow-container" class="space-y-3">
                        <!-- Dynamic inputs -->
                    </div>
                    <p class="text-[10px] text-gray-400 mt-4 italic">* ·∫¢nh ƒë·∫ßu ti√™n s·∫Ω d√πng l√†m ·∫£nh ƒë·∫°i di·ªán (Thumbnail)
                        c·ªßa card tour.</p>
                </div>

                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center justify-between">
                        <div class="flex items-center">
                            <i data-lucide="gallery-thumbnails" class="w-5 h-5 mr-3 text-primary"></i>
                            Th∆∞ vi·ªán ·∫£nh chi ti·∫øt
                        </div>
                        <button type="button" onclick="addImageField('detail-gallery-container')"
                            class="text-primary hover:bg-primary/5 px-3 py-1 rounded-lg text-xs font-bold border border-primary/20 transition-all">+
                            Th√™m ·∫£nh</button>
                    </h3>
                    <div id="detail-gallery-container" class="grid grid-cols-2 gap-4">
                        <!-- Dynamic inputs -->
                    </div>
                </div>
            </section>

            <!-- Step 3: Specs & Description -->
            <section id="step-3" class="step-content space-y-6">
                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                        <i data-lucide="Zap" class="w-5 h-5 mr-3 text-primary"></i>
                        Th√¥ng s·ªë k·ªπ thu·∫≠t (8 Specs)
                    </h3>
                    <div class="grid grid-cols-4 gap-6">
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">ƒê·ªãa ƒëi·ªÉm</label>
                            <input type="text" id="spec-location" placeholder="L√¢m ƒê·ªìng"
                                class="w-full px-3 py-2 rounded-lg border border-gray-100 text-sm">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Th·ªùi gian</label>
                            <input type="text" id="spec-duration" placeholder="2 ng√†y 1 ƒë√™m"
                                class="w-full px-3 py-2 rounded-lg border border-gray-100 text-sm">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Qu√£ng ƒë∆∞·ªùng</label>
                            <input type="text" id="spec-distance" placeholder="28 km"
                                class="w-full px-3 py-2 rounded-lg border border-gray-100 text-sm">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">ƒê·ªô cao</label>
                            <input type="text" id="spec-elevation" placeholder="1100 m"
                                class="w-full px-3 py-2 rounded-lg border border-gray-100 text-sm">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">C·∫•p ƒë·ªô</label>
                            <input type="text" id="spec-difficulty" placeholder="2/5 - C∆° b·∫£n"
                                class="w-full px-3 py-2 rounded-lg border border-gray-100 text-sm">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Di chuy·ªÉn</label>
                            <input type="text" id="spec-transport" placeholder="Xe gi∆∞·ªùng n·∫±m"
                                class="w-full px-3 py-2 rounded-lg border border-gray-100 text-sm">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">S·ªë l∆∞·ª£ng</label>
                            <input type="text" id="spec-quantity" placeholder="T·ªëi ƒëa 15 kh√°ch"
                                class="w-full px-3 py-2 rounded-lg border border-gray-100 text-sm">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">T·ªâ l·ªá Guide</label>
                            <input type="text" id="spec-guide-ratio" placeholder="1:4 (1 Guide : 4 Kh√°ch)"
                                class="w-full px-3 py-2 rounded-lg border border-gray-100 text-sm">
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                        <i data-lucide="file-text" class="w-5 h-5 mr-3 text-primary"></i>
                        Gi·ªõi thi·ªáu chi ti·∫øt
                    </h3>
                    <textarea id="tour-long-desc" rows="8"
                        placeholder="Vi·∫øt gi·ªõi thi·ªáu d√†i v·ªÅ h√†nh tr√¨nh, c√°c ƒëi·ªÉm nh·∫•n ƒë·∫∑c s·∫Øc..."
                        class="w-full px-4 py-3 rounded-xl border border-gray-100 focus:border-primary outline-none transition-all"></textarea>
                </div>
            </section>

            <!-- Step 4: Itinerary & Inclusions -->
            <section id="step-4" class="step-content space-y-6">
                <!-- Itinerary -->
                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center justify-between">
                        <div class="flex items-center">
                            <i data-lucide="map" class="w-5 h-5 mr-3 text-primary"></i>
                            L·ªãch tr√¨nh chi ti·∫øt
                        </div>
                        <button type="button" onclick="addItineraryDay()"
                            class="text-primary hover:bg-primary/5 px-3 py-1 rounded-lg text-xs font-bold border border-primary/20 transition-all">+
                            Th√™m ng√†y</button>
                    </h3>
                    <div id="itinerary-days-container" class="space-y-6">
                        <!-- Dynamic days -->
                    </div>
                </div>

                <!-- Inclusions -->
                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                        <i data-lucide="check-circle" class="w-5 h-5 mr-3 text-primary"></i>
                        D·ªãch v·ª• bao g·ªìm (Inclusions) - Ch·ªçn 12 m·ª•c PRO MAX
                    </h3>
                    <div id="inclusions-grid" class="grid grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Rendered by JS -->
                    </div>
                </div>

                <!-- Exclusions -->
                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center justify-between">
                        <div class="flex items-center">
                            <i data-lucide="x-circle" class="w-5 h-5 mr-3 text-primary"></i>
                            Kh√¥ng bao g·ªìm (Exclusions)
                        </div>
                        <button type="button" onclick="addExclusionRow()"
                            class="text-primary hover:bg-primary/5 px-3 py-1 rounded-lg text-xs font-bold border border-primary/20 transition-all">+
                            Th√™m m·ª•c</button>
                    </h3>
                    <div id="exclusions-container" class="space-y-3">
                        <!-- Dynamic exclusions -->
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                        <i data-lucide="shield-alert" class="w-5 h-5 mr-3 text-primary"></i>
                        L∆∞u √Ω & Chu·∫©n b·ªã
                    </h3>
                    <textarea id="tour-note" rows="4"
                        placeholder="Th√¥ng tin v·ªÅ s·ª©c kh·ªèe, ƒë·ªì d√πng c√° nh√¢n c·∫ßn mang theo..."
                        class="w-full px-4 py-3 rounded-xl border border-gray-100 focus:border-primary outline-none transition-all"></textarea>
                </div>
            </section>

            <!-- Navigation Buttons -->
            <div class="fixed bottom-0 left-0 w-full bg-white/80 backdrop-blur-md border-t border-gray-100 p-6 z-50">
                <div class="max-w-5xl mx-auto flex justify-between items-center">
                    <button type="button" id="prevBtn" onclick="changeStep(-1)"
                        class="px-8 py-3 rounded-2xl font-bold text-gray-400 hover:text-gray-600 transition-all hidden flex items-center">
                        <i data-lucide="chevron-left" class="w-5 h-5 mr-2"></i> Quay l·∫°i
                    </button>
                    <div class="flex-1"></div>
                    <button type="button" id="nextBtn" onclick="changeStep(1)"
                        class="bg-primary text-white px-10 py-4 rounded-2xl font-bold shadow-lg shadow-primary/30 hover:scale-[1.02] active:scale-95 transition-all flex items-center">
                        Ti·∫øp theo <i data-lucide="chevron-right" class="w-5 h-5 ml-2"></i>
                    </button>
                    <button type="submit" id="submitBtn"
                        class="bg-primary text-white px-10 py-4 rounded-2xl font-bold shadow-lg shadow-primary/30 hover:scale-[1.02] active:scale-95 transition-all hidden flex items-center">
                        Ho√†n t·∫•t & L∆∞u Tour <i data-lucide="save" class="w-5 h-5 ml-2"></i>
                    </button>
                </div>
            </div>
        </form>
    </main>

    <script>
        let currentStep = 1;
        const totalSteps = 4;

        // Configuration for Inclusions
        const DEFAULT_INCLUSIONS = [
            { id: 'trans', title: 'Di chuy·ªÉn', icon: 'bus', desc: 'Xe gi∆∞·ªùng n·∫±m kh·ª© h·ªìi ƒë·ªùi m·ªõi, ch·∫•t l∆∞·ª£ng cao.' },
            { id: 'tent', title: 'L∆∞u tr√∫', icon: 'tent', desc: 'L·ªÅu tr·∫°i cao c·∫•p, t√∫i ng·ªß, c√°ch nhi·ªát chuy√™n d·ª•ng.' },
            { id: 'food', title: 'ƒÇn u·ªëng', icon: 'utensils', desc: 'Cung c·∫•p ƒë·ªß c√°c b·ªØa ƒÉn ch√≠nh/ph·ª• v·ªõi th·ª±c ƒë∆°n ƒëa d·∫°ng.' },
            { id: 'guide', title: 'D·∫´n ƒëo√†n', icon: 'users', desc: 'HDV am hi·ªÉu ƒë·ªãa h√¨nh, chuy√™n nghi·ªáp, h·ªó tr·ª£ nhi·ªát t√¨nh.' },
            { id: 'porter', title: 'Porter', icon: 'backpack', desc: 'H·ªó tr·ª£ mang v√°c v·∫≠t d·ª•ng chung, ƒë·ªì ƒÉn, l·ªÅu tr·∫°i.' },
            { id: 'insure', title: 'B·∫£o hi·ªÉm', icon: 'shield-check', desc: 'B·∫£o hi·ªÉm du l·ªãch m·∫°o hi·ªÉm t·ªëi ƒëa 50,000,000 VNƒê.' },
            { id: 'equip', title: 'Thi·∫øt b·ªã', icon: 'mountain', desc: 'G·∫≠y leo n√∫i, b·ªô ƒë√†m, thi·∫øt b·ªã s∆° c·ª©u chuy√™n d·ª•ng.' },
            { id: 'drink', title: 'N∆∞·ªõc u·ªëng', icon: 'droplets', desc: 'N∆∞·ªõc su·ªëi ƒë√≥ng chai ph·ª•c v·ª• su·ªët h√†nh tr√¨nh.' },
            { id: 'ticket', title: 'V√© tham quan', icon: 'ticket', desc: 'To√†n b·ªô ph√≠ v√†o c·ªïng, v·ªá sinh, qu·∫£n l√Ω r·ª´ng.' },
            { id: 'med', title: 'Medical', icon: 'heart-pulse', desc: 'T√∫i y t·∫ø c√° nh√¢n v√† thi·∫øt b·ªã ƒëo ch·ªâ s·ªë s·ª©c kh·ªèe.' },
            { id: 'photo', title: 'Nhi·∫øp ·∫£nh', icon: 'camera', desc: 'H·ªó tr·ª£ ch·ª•p h√¨nh, quay phim trong su·ªët chuy·∫øn ƒëi.' },
            { id: 'gifts', title: 'Qu√† t·∫∑ng', icon: 'gift', desc: '√Åo thun k·ª∑ ni·ªám, m√≥c kh√≥a ho·∫∑c ch·ª©ng nh·∫≠n ho√†n th√†nh.' }
        ];

        function init() {
            lucide.createIcons();
            renderInclusionsGrid();

            // Check for edit mode
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('id');
            if (editId) {
                loadTourForEdit(editId);
            } else {
                // Initialize default empty fields
                addImageField('card-slideshow-container');
                addImageField('detail-gallery-container');
                addImageField('detail-gallery-container');
                addItineraryDay({ day: 'Ng√†y 0', title: 'Kh·ªüi h√†nh', events: [] });
                addExclusionRow();
            }
        }

        function changeStep(n) {
            const nextStep = currentStep + n;
            if (nextStep < 1 || nextStep > totalSteps) return;

            // Simple validation for Step 1
            if (n > 0 && currentStep === 1) {
                if (!document.getElementById('tour-name').value) {
                    alert('Vui l√≤ng nh·∫≠p t√™n Tour');
                    return;
                }
            }

            document.getElementById(`step-${currentStep}`).classList.remove('active');
            currentStep = nextStep;
            document.getElementById(`step-${currentStep}`).classList.add('active');

            updateStepperUI();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateStepperUI() {
            for (let i = 1; i <= totalSteps; i++) {
                const dot = document.getElementById(`dot-${i}`);
                if (i < currentStep) {
                    dot.classList.remove('active');
                    dot.classList.add('completed');
                    dot.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>';
                } else if (i === currentStep) {
                    dot.classList.add('active');
                    dot.classList.remove('completed');
                    dot.innerText = i;
                } else {
                    dot.classList.remove('active', 'completed');
                    dot.innerText = i;
                }
            }
            lucide.createIcons();

            // Nav buttons
            document.getElementById('prevBtn').classList.toggle('hidden', currentStep === 1);
            document.getElementById('nextBtn').classList.toggle('hidden', currentStep === totalSteps);
            document.getElementById('submitBtn').classList.toggle('hidden', currentStep !== totalSteps);
        }

        // --- Form Rendering Helpers ---

        function addImageField(containerId, value = '') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'flex space-x-2 group';
            div.innerHTML = `
                <input type="text" value="${value}" placeholder="Link ·∫£nh (https://...)" class="flex-1 px-4 py-2 rounded-lg border border-gray-100 text-xs focus:border-primary outline-none">
                <button type="button" onclick="this.parentElement.remove()" class="p-2 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            `;
            container.appendChild(div);
            lucide.createIcons();
        }

        function addItineraryDay(data = null) {
            const container = document.getElementById('itinerary-days-container');
            const dayDiv = document.createElement('div');
            dayDiv.className = 'bg-gray-50/50 p-6 rounded-2xl border border-gray-100 space-y-4';

            dayDiv.innerHTML = `
                <div class="flex space-x-4">
                    <div class="w-24">
                        <label class="block text-[10px] font-bold text-gray-400 mb-1">NG√ÄY</label>
                        <input type="text" value="${data ? data.day : 'Ng√†y 1'}" class="tour-itinerary-day-label w-full px-3 py-2 rounded-lg border bg-white font-bold text-sm">
                    </div>
                    <div class="flex-1">
                        <label class="block text-[10px] font-bold text-gray-400 mb-1">TI√äU ƒê·ªÄ NG√ÄY</label>
                        <input type="text" value="${data ? data.title : 'H√†nh tr√¨nh b·∫Øt ƒë·∫ßu'}" class="tour-itinerary-day-title w-full px-3 py-2 rounded-lg border bg-white font-bold text-sm">
                    </div>
                    <button type="button" onclick="this.closest('.bg-gray-50\\/50').remove()" class="mt-6 text-gray-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
                <div class="tour-day-events-container space-y-2">
                    <!-- Events here -->
                </div>
                <button type="button" onclick="addItineraryEvent(this.parentElement.querySelector('.tour-day-events-container'))" class="text-[10px] font-bold text-primary">+ TH√äM HO·∫†T ƒê·ªòNG</button>
            `;
            container.appendChild(dayDiv);

            const eventsCont = dayDiv.querySelector('.tour-day-events-container');
            if (data && data.events) {
                data.events.forEach(e => addItineraryEvent(eventsCont, e));
            } else {
                addItineraryEvent(eventsCont);
            }
            lucide.createIcons();
        }

        function addItineraryEvent(container, val = '') {
            const row = document.createElement('div');
            row.className = 'flex space-x-2 group items-center';
            let time = '', content = val;
            if (val.includes(': ')) {
                [time, content] = val.split(': ');
            }
            row.innerHTML = `
                <input type="text" value="${time}" placeholder="8h00" class="tour-event-time w-20 px-3 py-1.5 rounded-lg border bg-white text-xs">
                <input type="text" value="${content}" placeholder="ƒÇn s√°ng v√† kh·ªüi h√†nh" class="tour-event-content flex-1 px-3 py-1.5 rounded-lg border bg-white text-xs">
                <button type="button" onclick="this.parentElement.remove()" class="p-1.5 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><i data-lucide="x" class="w-3 h-3"></i></button>
            `;
            container.appendChild(row);
            lucide.createIcons();
        }

        function renderInclusionsGrid() {
            const grid = document.getElementById('inclusions-grid');
            grid.innerHTML = '';
            DEFAULT_INCLUSIONS.forEach(item => {
                const div = document.createElement('div');
                div.className = 'inclusion-item p-4 rounded-2xl border border-gray-100 hover:border-primary/20 transition-all bg-white relative';
                div.innerHTML = `
                    <label class="flex items-start cursor-pointer">
                        <input type="checkbox" id="inc-${item.id}" class="mt-1 mr-3 h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary" onchange="toggleInclusionStyle(this)">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-1">
                                <i data-lucide="${item.icon}" class="inclusion-icon w-4 h-4 text-primary grayscale opacity-50"></i>
                                <span class="text-xs font-bold text-gray-800">${item.title}</span>
                            </div>
                            <textarea rows="2" class="w-full bg-transparent text-[10px] text-gray-500 border-none p-0 outline-none resize-none overflow-hidden" placeholder="M√¥ t·∫£ chi ti·∫øt...">${item.desc}</textarea>
                        </div>
                    </label>
                `;
                grid.appendChild(div);
            });
            lucide.createIcons();
        }

        function toggleInclusionStyle(cb) {
            const div = cb.closest('.inclusion-item');
            const icon = div.querySelector('.inclusion-icon');
            if (cb.checked) {
                div.classList.add('bg-primary/5', 'border-primary/20');
                icon.classList.remove('grayscale', 'opacity-50');
            } else {
                div.classList.remove('bg-primary/5', 'border-primary/20');
                icon.classList.add('grayscale', 'opacity-50');
            }
        }

        function addExclusionRow(data = null) {
            const container = document.getElementById('exclusions-container');
            const row = document.createElement('div');
            row.className = 'flex space-x-3 group';
            row.innerHTML = `
                <input type="text" value="${data ? data.title : ''}" placeholder="Ti√™u ƒë·ªÅ (VD: Chi ph√≠ c√° nh√¢n)" class="tour-exclusion-title w-1/3 px-4 py-2 rounded-xl border border-gray-100 text-xs">
                <input type="text" value="${data ? data.content : ''}" placeholder="M√¥ t·∫£ (VD: C√† ph√™, n∆∞·ªõc ng·ªçt ngo√†i ch∆∞∆°ng tr√¨nh...)" class="tour-exclusion-content flex-1 px-4 py-2 rounded-xl border border-gray-100 text-xs">
                <button type="button" onclick="this.parentElement.remove()" class="p-2 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"><i data-lucide="x" class="w-4 h-4"></i></button>
            `;
            container.appendChild(row);
            lucide.createIcons();
        }

        // --- Logic Handlers ---

        async function loadTourForEdit(id) {
            try {
                const res = await fetch(`/.netlify/functions/get-tours`);
                const tours = await res.json();
                const tour = tours.find(t => t.id == id);
                if (!tour) return;

                document.getElementById('edit-id').value = tour.id;
                document.getElementById('tour-name').value = tour.name;
                document.getElementById('tour-slug').value = tour.slug;
                document.getElementById('tour-hero-image').value = tour.hero_image || '';
                document.getElementById('tour-short-desc').value = tour.short_desc || '';
                document.getElementById('tour-long-desc').value = tour.long_desc || '';
                document.getElementById('tour-region').value = tour.region || 'Mi·ªÅn Nam';
                document.getElementById('tour-type').value = tour.type || 'TREKKING';
                document.getElementById('tour-price').value = tour.price;
                document.getElementById('tour-note').value = tour.preparation || '';

                // Restore dynamic fields...
                document.getElementById('card-slideshow-container').innerHTML = '';
                const imgs = [tour.image, tour.image2, tour.image3, tour.image4].filter(v => v);
                imgs.forEach(img => addImageField('card-slideshow-container', img));

                document.getElementById('detail-gallery-container').innerHTML = '';
                if (tour.gallery) tour.gallery.forEach(img => addImageField('detail-gallery-container', img));

                // Specs
                const s = tour.specs || {};
                document.getElementById('spec-location').value = s.location || '';
                document.getElementById('spec-duration').value = s.duration || '';
                document.getElementById('spec-distance').value = s.distance || '';
                document.getElementById('spec-elevation').value = s.elevation || '';
                document.getElementById('spec-difficulty').value = s.difficulty || '';
                document.getElementById('spec-transport').value = s.transport || '';
                document.getElementById('spec-quantity').value = s.quantity || '';
                document.getElementById('spec-guide-ratio').value = s.guide_ratio || '';

                // Itinerary
                document.getElementById('itinerary-days-container').innerHTML = '';
                if (tour.itinerary) tour.itinerary.forEach(d => addItineraryDay(d));

                // Exclusions
                document.getElementById('exclusions-container').innerHTML = '';
                if (tour.exclusions) tour.exclusions.forEach(ex => addExclusionRow(ex));

                // Inclusions
                if (tour.inclusions) {
                    tour.inclusions.forEach(inc => {
                        const cb = document.getElementById(`inc-${inc.id}`);
                        if (cb) {
                            cb.checked = true;
                            cb.closest('.inclusion-item').querySelector('textarea').value = inc.desc;
                            toggleInclusionStyle(cb);
                        }
                    });
                }

                document.getElementById('tour-duration-top').value = tour.duration || '';
                document.getElementById('tour-altitude-top').value = tour.altitude || '';
                document.getElementById('tour-level-top').value = tour.level || 'C∆° b·∫£n';

                document.querySelector('h1').innerText = 'Ch·ªânh s·ª≠a: ' + tour.name;
            } catch (err) {
                console.error(err);
            }
        }

        async function saveTour(event) {
            if (event) event.preventDefault();
            console.log("Submit triggered at:", new Date().toLocaleTimeString());

            const submitBtn = document.getElementById('submitBtn');
            const originalHTML = submitBtn.innerHTML;

            try {
                // Helper de lay gia tri an toan
                const getVal = (id) => document.getElementById(id)?.value?.trim() || '';

                // VALIDATION THU CONG
                const name = getVal('tour-name');
                const price = getVal('tour-price');
                const duration = getVal('tour-duration-top');

                if (!name) throw new Error("Vui l√≤ng nh·∫≠p T√™n Tour (B∆∞·ªõc 1)");
                if (!price) throw new Error("Vui l√≤ng nh·∫≠p Gi√° Tour (B∆∞·ªõc 1)");
                if (!duration) throw new Error("Vui l√≤ng nh·∫≠p Th·ªùi gian (B∆∞·ªõc 1)");

                submitBtn.disabled = true;
                submitBtn.innerText = 'ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...';

                console.log("Thu thap hinh anh...");
                const cardImages = Array.from(document.getElementById('card-slideshow-container').querySelectorAll('input')).map(i => i.value).filter(v => v);
                const galleryImages = Array.from(document.getElementById('detail-gallery-container').querySelectorAll('input')).map(i => i.value).filter(v => v);

                console.log("Thu thap lich trinh...");
                const itinerary = Array.from(document.getElementById('itinerary-days-container').children).map(div => {
                    const labelInput = div.querySelector('.tour-itinerary-day-label');
                    const titleInput = div.querySelector('.tour-itinerary-day-title');
                    if (!labelInput) return null;

                    const day = labelInput.value;
                    const title = titleInput ? titleInput.value : '';
                    const eventRows = div.querySelectorAll('.tour-day-events-container > div');
                    const events = Array.from(eventRows).map(e => {
                        const tEl = e.querySelector('.tour-event-time');
                        const cEl = e.querySelector('.tour-event-content');
                        if (!cEl) return null;
                        const t = tEl ? tEl.value.trim() : '';
                        const c = cEl.value.trim();
                        return t ? `${t}: ${c}` : c;
                    }).filter(v => v);
                    return { day, title, events };
                }).filter(v => v);

                console.log("Thu thap inclusions...");
                const inclusions = [];
                DEFAULT_INCLUSIONS.forEach(item => {
                    const cb = document.getElementById(`inc-${item.id}`);
                    if (cb && cb.checked) {
                        const itemDiv = cb.closest('.inclusion-item');
                        const desc = itemDiv ? itemDiv.querySelector('textarea').value : item.desc;
                        inclusions.push({ id: item.id, title: item.title, icon: item.icon, desc });
                    }
                });

                console.log("Thu thap exclusions...");
                const exclusions = Array.from(document.getElementById('exclusions-container').children).map(row => {
                    const tEl = row.querySelector('.tour-exclusion-title');
                    const cEl = row.querySelector('.tour-exclusion-content');
                    if (!tEl) return null;
                    return {
                        title: tEl.value.trim(),
                        content: cEl ? cEl.value.trim() : ''
                    };
                }).filter(v => v && v.title);

                const id = getVal('edit-id');
                const tour = {
                    id: id ? parseInt(id) : null,
                    name,
                    slug: getVal('tour-slug'),
                    image: cardImages[0] || '',
                    image2: cardImages[1] || '',
                    image3: cardImages[2] || '',
                    image4: cardImages[3] || '',
                    hero_image: getVal('tour-hero-image'),
                    short_desc: getVal('tour-short-desc'),
                    long_desc: getVal('tour-long-desc'),
                    region: getVal('tour-region'),
                    type: getVal('tour-type'),
                    price: parseInt(price) || 0,
                    duration,
                    altitude: getVal('tour-altitude-top'),
                    level: getVal('tour-level-top'),
                    specs: {
                        location: getVal('spec-location'),
                        duration: getVal('spec-duration'),
                        distance: getVal('spec-distance'),
                        elevation: getVal('spec-elevation'),
                        difficulty: getVal('spec-difficulty'),
                        transport: getVal('spec-transport'),
                        quantity: getVal('spec-quantity'),
                        guide_ratio: getVal('spec-guide-ratio')
                    },
                    itinerary, inclusions, exclusions,
                    preparation: getVal('tour-note'),
                    gallery: galleryImages
                };

                console.log("Sending Data:", tour);

                if (window.location.protocol === 'file:') {
                    throw new Error("·ª®ng d·ª•ng c·∫ßn ch·∫°y qua server (Netlify Dev) ƒë·ªÉ g·ªçi API. Kh√¥ng th·ªÉ l∆∞u khi m·ªü file tr·ª±c ti·∫øp.");
                }

                submitBtn.innerText = 'ƒêang g·ª≠i l√™n Server...';
                const res = await fetch('/.netlify/functions/save-tour', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(tour)
                });

                if (!res.ok) {
                    const errorResp = await res.json().catch(() => ({}));
                    throw new Error(errorResp.error || 'L·ªói server ' + res.status);
                }

                alert('üéâ Ch√∫c m·ª´ng! H√†nh tr√¨nh ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng.');
                window.location.href = '/ADMIN/tours.html';
            } catch (err) {
                console.error("Critical Error in saveTour:", err);
                alert('C·∫¢NH B√ÅO: ' + err.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalHTML;
            }
        }

        // Auto Slug
        document.getElementById('tour-name').addEventListener('input', (e) => {
            if (document.getElementById('edit-id').value) return;
            let slug = e.target.value.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[ƒëƒê]/g, 'd')
                .replace(/([^0-9a-z-\s])/g, '').replace(/(\s+)/g, '-').replace(/-+/g, '-').replace(/^-+|-+$/g, '');
            document.getElementById('tour-slug').value = slug;
        });

        init();
    </script>
</body>

</html>