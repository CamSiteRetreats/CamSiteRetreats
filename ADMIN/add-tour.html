<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tạo Tour Mới | CAM SITE RETREATS Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Lexend', sans-serif;
            background-color: #f8fafc;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .bg-primary {
            background-color: #FF5A1F;
        }

        .text-primary {
            color: #FF5A1F;
        }

        .border-primary {
            border-color: #FF5A1F;
        }

        .step-dot.active {
            background-color: #FF5A1F;
            border-color: #FF5A1F;
            color: white;
        }

        .step-dot.completed {
            background-color: #10b981;
            border-color: #10b981;
            color: white;
        }
    </style>
</head>

<body class="min-h-screen pb-24">
    <nav class="bg-white border-b border-gray-100 sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <a href="/ADMIN/tours.html" class="p-2 hover:bg-gray-50 rounded-lg transition-all">
                    <i data-lucide="arrow-left" class="w-6 h-6 text-gray-500"></i>
                </a>
                <h1 class="text-xl font-bold text-gray-800">Tạo Hành Trình Mới</h1>
            </div>
            <div class="flex items-center space-x-2">
                <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Trạng thái:</span>
                <span
                    class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-[10px] font-bold uppercase">Nháp</span>
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto px-6 mt-8">
        <!-- Stepper -->
        <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100 mb-8">
            <div class="flex items-center justify-between relative">
                <div class="absolute top-1/2 left-0 w-full h-0.5 bg-gray-100 -translate-y-1/2 z-0"></div>

                <div class="relative z-10 flex flex-col items-center group">
                    <div id="dot-1"
                        class="step-dot active w-10 h-10 rounded-full border-2 border-gray-200 bg-white flex items-center justify-center font-bold text-sm transition-all">
                        1</div>
                    <span class="text-[10px] font-bold mt-2 text-gray-400 uppercase">Cơ bản</span>
                </div>

                <div class="relative z-10 flex flex-col items-center">
                    <div id="dot-2"
                        class="step-dot w-10 h-10 rounded-full border-2 border-gray-200 bg-white flex items-center justify-center font-bold text-sm transition-all">
                        2</div>
                    <span class="text-[10px] font-bold mt-2 text-gray-400 uppercase">Media</span>
                </div>

                <div class="relative z-10 flex flex-col items-center">
                    <div id="dot-3"
                        class="step-dot w-10 h-10 rounded-full border-2 border-gray-200 bg-white flex items-center justify-center font-bold text-sm transition-all">
                        3</div>
                    <span class="text-[10px] font-bold mt-2 text-gray-400 uppercase">Thông số</span>
                </div>

                <div class="relative z-10 flex flex-col items-center">
                    <div id="dot-4"
                        class="step-dot w-10 h-10 rounded-full border-2 border-gray-200 bg-white flex items-center justify-center font-bold text-sm transition-all">
                        4</div>
                    <span class="text-[10px] font-bold mt-2 text-gray-400 uppercase">Phụ lục</span>
                </div>
            </div>
        </div>

        <form id="addTourForm" onsubmit="saveTour(event)">
            <input type="hidden" id="edit-id">

            <!-- Step 1: Basic Info -->
            <section id="step-1" class="step-content active space-y-6">
                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                        <i data-lucide="info" class="w-5 h-5 mr-3 text-primary"></i>
                        Thông tin định danh
                    </h3>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="col-span-2">
                            <label class="block text-sm font-bold text-gray-700 mb-2">Tên Tour</label>
                            <input type="text" id="tour-name" placeholder="VD: Tà Năng Phan Dũng" required
                                class="w-full px-4 py-3 rounded-xl border border-gray-100 focus:border-primary outline-none transition-all">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-sm font-bold text-gray-700 mb-2">Slug (Đường dẫn)</label>
                            <input type="text" id="tour-slug" placeholder="ta-nang-phan-dung" required
                                class="w-full px-4 py-3 rounded-xl border border-gray-100 bg-gray-50 font-mono text-xs">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-sm font-bold text-gray-700 mb-2">Giá Tour (VNĐ)</label>
                            <input type="number" id="tour-price" placeholder="2800000" required
                                class="w-full px-4 py-3 rounded-xl border border-gray-100 focus:border-primary outline-none transition-all font-bold text-primary">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-sm font-bold text-gray-700 mb-2">Vùng Miền</label>
                            <select id="tour-region"
                                class="w-full px-4 py-3 rounded-xl border border-gray-100 outline-none">
                                <option>Miền Nam</option>
                                <option>Miền Trung</option>
                                <option>Miền Bắc</option>
                                <option>Tây Nguyên</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label class="block text-sm font-bold text-gray-700 mb-2">Loại Hình</label>
                            <select id="tour-type"
                                class="w-full px-4 py-3 rounded-xl border border-gray-100 outline-none">
                                <option>TREKKING</option>
                                <option>HIKING</option>
                                <option>CAMPING</option>
                                <option>CYCLING</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                        <i data-lucide="align-left" class="w-5 h-5 mr-3 text-primary"></i>
                        Mô tả tóm tắt
                    </h3>
                    <textarea id="tour-short-desc" rows="4" placeholder="Viết mô tả ngắn gọn thu hút khách hàng..."
                        class="w-full px-4 py-3 rounded-xl border border-gray-100 focus:border-primary outline-none transition-all"></textarea>
                </div>
            </section>

            <!-- Step 2: Media -->
            <section id="step-2" class="step-content space-y-6">
                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                        <i data-lucide="image" class="w-5 h-5 mr-3 text-primary"></i>
                        Ảnh bìa chi tiết (Social Preview)
                    </h3>
                    <div class="space-y-4">
                        <input type="text" id="tour-hero-image" placeholder="https://example.com/hero.jpg"
                            class="w-full px-4 py-3 rounded-xl border border-gray-100 focus:border-primary outline-none transition-all">
                        <p class="text-[10px] text-gray-400 italic">Dùng làm hình ảnh hiển thị khi chia sẻ link lên
                            Facebook/Zalo và ảnh bìa trang chi tiết.</p>
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center justify-between">
                        <div class="flex items-center">
                            <i data-lucide="images" class="w-5 h-5 mr-3 text-primary"></i>
                            Ảnh Slideshow sản phẩm
                        </div>
                        <button type="button" onclick="addImageField('card-slideshow-container')"
                            class="text-primary hover:bg-primary/5 px-3 py-1 rounded-lg text-xs font-bold border border-primary/20 transition-all">+
                            Thêm ảnh</button>
                    </h3>
                    <div id="card-slideshow-container" class="space-y-3">
                        <!-- Dynamic inputs -->
                    </div>
                    <p class="text-[10px] text-gray-400 mt-4 italic">* Ảnh đầu tiên sẽ dùng làm ảnh đại diện (Thumbnail)
                        của card tour.</p>
                </div>

                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center justify-between">
                        <div class="flex items-center">
                            <i data-lucide="gallery-thumbnails" class="w-5 h-5 mr-3 text-primary"></i>
                            Thư viện ảnh chi tiết
                        </div>
                        <button type="button" onclick="addImageField('detail-gallery-container')"
                            class="text-primary hover:bg-primary/5 px-3 py-1 rounded-lg text-xs font-bold border border-primary/20 transition-all">+
                            Thêm ảnh</button>
                    </h3>
                    <div id="detail-gallery-container" class="grid grid-cols-2 gap-4">
                        <!-- Dynamic inputs -->
                    </div>
                </div>
            </section>

            <!-- Step 3: Specs & Description -->
            <section id="step-3" class="step-content space-y-6">
                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                        <i data-lucide="Zap" class="w-5 h-5 mr-3 text-primary"></i>
                        Thông số kỹ thuật (8 Specs)
                    </h3>
                    <div class="grid grid-cols-4 gap-6">
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Địa điểm</label>
                            <input type="text" id="spec-location" placeholder="Lâm Đồng"
                                class="w-full px-3 py-2 rounded-lg border border-gray-100 text-sm">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Thời gian</label>
                            <input type="text" id="spec-duration" placeholder="2 ngày 1 đêm"
                                class="w-full px-3 py-2 rounded-lg border border-gray-100 text-sm">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Quãng đường</label>
                            <input type="text" id="spec-distance" placeholder="28 km"
                                class="w-full px-3 py-2 rounded-lg border border-gray-100 text-sm">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Độ cao</label>
                            <input type="text" id="spec-elevation" placeholder="1100 m"
                                class="w-full px-3 py-2 rounded-lg border border-gray-100 text-sm">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Cấp độ</label>
                            <input type="text" id="spec-difficulty" placeholder="2/5 - Cơ bản"
                                class="w-full px-3 py-2 rounded-lg border border-gray-100 text-sm">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Di chuyển</label>
                            <input type="text" id="spec-transport" placeholder="Xe giường nằm"
                                class="w-full px-3 py-2 rounded-lg border border-gray-100 text-sm">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Số lượng</label>
                            <input type="text" id="spec-quantity" placeholder="Tối đa 15 khách"
                                class="w-full px-3 py-2 rounded-lg border border-gray-100 text-sm">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Tỉ lệ Guide</label>
                            <input type="text" id="spec-guide-ratio" placeholder="1:4 (1 Guide : 4 Khách)"
                                class="w-full px-3 py-2 rounded-lg border border-gray-100 text-sm">
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                        <i data-lucide="file-text" class="w-5 h-5 mr-3 text-primary"></i>
                        Giới thiệu chi tiết
                    </h3>
                    <textarea id="tour-long-desc" rows="8"
                        placeholder="Viết giới thiệu dài về hành trình, các điểm nhấn đặc sắc..."
                        class="w-full px-4 py-3 rounded-xl border border-gray-100 focus:border-primary outline-none transition-all"></textarea>
                </div>
            </section>

            <!-- Step 4: Itinerary & Inclusions -->
            <section id="step-4" class="step-content space-y-6">
                <!-- Itinerary -->
                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center justify-between">
                        <div class="flex items-center">
                            <i data-lucide="map" class="w-5 h-5 mr-3 text-primary"></i>
                            Lịch trình chi tiết
                        </div>
                        <button type="button" onclick="addItineraryDay()"
                            class="text-primary hover:bg-primary/5 px-3 py-1 rounded-lg text-xs font-bold border border-primary/20 transition-all">+
                            Thêm ngày</button>
                    </h3>
                    <div id="itinerary-days-container" class="space-y-6">
                        <!-- Dynamic days -->
                    </div>
                </div>

                <!-- Inclusions -->
                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                        <i data-lucide="check-circle" class="w-5 h-5 mr-3 text-primary"></i>
                        Dịch vụ bao gồm (Inclusions) - Chọn 12 mục PRO MAX
                    </h3>
                    <div id="inclusions-grid" class="grid grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Rendered by JS -->
                    </div>
                </div>

                <!-- Exclusions -->
                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center justify-between">
                        <div class="flex items-center">
                            <i data-lucide="x-circle" class="w-5 h-5 mr-3 text-primary"></i>
                            Không bao gồm (Exclusions)
                        </div>
                        <button type="button" onclick="addExclusionRow()"
                            class="text-primary hover:bg-primary/5 px-3 py-1 rounded-lg text-xs font-bold border border-primary/20 transition-all">+
                            Thêm mục</button>
                    </h3>
                    <div id="exclusions-container" class="space-y-3">
                        <!-- Dynamic exclusions -->
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                        <i data-lucide="shield-alert" class="w-5 h-5 mr-3 text-primary"></i>
                        Lưu ý & Chuẩn bị
                    </h3>
                    <textarea id="tour-note" rows="4"
                        placeholder="Thông tin về sức khỏe, đồ dùng cá nhân cần mang theo..."
                        class="w-full px-4 py-3 rounded-xl border border-gray-100 focus:border-primary outline-none transition-all"></textarea>
                </div>
            </section>

            <!-- Navigation Buttons -->
            <div class="fixed bottom-0 left-0 w-full bg-white/80 backdrop-blur-md border-t border-gray-100 p-6 z-50">
                <div class="max-w-5xl mx-auto flex justify-between items-center">
                    <button type="button" id="prevBtn" onclick="changeStep(-1)"
                        class="px-8 py-3 rounded-2xl font-bold text-gray-400 hover:text-gray-600 transition-all hidden flex items-center">
                        <i data-lucide="chevron-left" class="w-5 h-5 mr-2"></i> Quay lại
                    </button>
                    <div class="flex-1"></div>
                    <button type="button" id="nextBtn" onclick="changeStep(1)"
                        class="bg-primary text-white px-10 py-4 rounded-2xl font-bold shadow-lg shadow-primary/30 hover:scale-[1.02] active:scale-95 transition-all flex items-center">
                        Tiếp theo <i data-lucide="chevron-right" class="w-5 h-5 ml-2"></i>
                    </button>
                    <button type="submit" id="submitBtn"
                        class="bg-primary text-white px-10 py-4 rounded-2xl font-bold shadow-lg shadow-primary/30 hover:scale-[1.02] active:scale-95 transition-all hidden flex items-center">
                        Hoàn tất & Lưu Tour <i data-lucide="save" class="w-5 h-5 ml-2"></i>
                    </button>
                </div>
            </div>
        </form>
    </main>

    <script>
        let currentStep = 1;
        const totalSteps = 4;

        // Configuration for Inclusions
        const DEFAULT_INCLUSIONS = [
            { id: 'trans', title: 'Di chuyển', icon: 'bus', desc: 'Xe giường nằm khứ hồi đời mới, chất lượng cao.' },
            { id: 'tent', title: 'Lưu trú', icon: 'tent', desc: 'Lều trại cao cấp, túi ngủ, cách nhiệt chuyên dụng.' },
            { id: 'food', title: 'Ăn uống', icon: 'utensils', desc: 'Cung cấp đủ các bữa ăn chính/phụ với thực đơn đa dạng.' },
            { id: 'guide', title: 'Dẫn đoàn', icon: 'users', desc: 'HDV am hiểu địa hình, chuyên nghiệp, hỗ trợ nhiệt tình.' },
            { id: 'porter', title: 'Porter', icon: 'backpack', desc: 'Hỗ trợ mang vác vật dụng chung, đồ ăn, lều trại.' },
            { id: 'insure', title: 'Bảo hiểm', icon: 'shield-check', desc: 'Bảo hiểm du lịch mạo hiểm tối đa 50,000,000 VNĐ.' },
            { id: 'equip', title: 'Thiết bị', icon: 'mountain', desc: 'Gậy leo núi, bộ đàm, thiết bị sơ cứu chuyên dụng.' },
            { id: 'drink', title: 'Nước uống', icon: 'droplets', desc: 'Nước suối đóng chai phục vụ suốt hành trình.' },
            { id: 'ticket', title: 'Vé tham quan', icon: 'ticket', desc: 'Toàn bộ phí vào cổng, vệ sinh, quản lý rừng.' },
            { id: 'med', title: 'Medical', icon: 'heart-pulse', desc: 'Túi y tế cá nhân và thiết bị đo chỉ số sức khỏe.' },
            { id: 'photo', title: 'Nhiếp ảnh', icon: 'camera', desc: 'Hỗ trợ chụp hình, quay phim trong suốt chuyến đi.' },
            { id: 'gifts', title: 'Quà tặng', icon: 'gift', desc: 'Áo thun kỷ niệm, móc khóa hoặc chứng nhận hoàn thành.' }
        ];

        function init() {
            lucide.createIcons();
            renderInclusionsGrid();

            // Check for edit mode
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('id');
            if (editId) {
                loadTourForEdit(editId);
            } else {
                // Initialize default empty fields
                addImageField('card-slideshow-container');
                addImageField('detail-gallery-container');
                addImageField('detail-gallery-container');
                addItineraryDay({ day: 'Ngày 0', title: 'Khởi hành', events: [] });
                addExclusionRow();
            }
        }

        function changeStep(n) {
            const nextStep = currentStep + n;
            if (nextStep < 1 || nextStep > totalSteps) return;

            // Simple validation for Step 1
            if (n > 0 && currentStep === 1) {
                if (!document.getElementById('tour-name').value) {
                    alert('Vui lòng nhập tên Tour');
                    return;
                }
            }

            document.getElementById(`step-${currentStep}`).classList.remove('active');
            currentStep = nextStep;
            document.getElementById(`step-${currentStep}`).classList.add('active');

            updateStepperUI();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateStepperUI() {
            for (let i = 1; i <= totalSteps; i++) {
                const dot = document.getElementById(`dot-${i}`);
                if (i < currentStep) {
                    dot.classList.remove('active');
                    dot.classList.add('completed');
                    dot.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>';
                } else if (i === currentStep) {
                    dot.classList.add('active');
                    dot.classList.remove('completed');
                    dot.innerText = i;
                } else {
                    dot.classList.remove('active', 'completed');
                    dot.innerText = i;
                }
            }
            lucide.createIcons();

            // Nav buttons
            document.getElementById('prevBtn').classList.toggle('hidden', currentStep === 1);
            document.getElementById('nextBtn').classList.toggle('hidden', currentStep === totalSteps);
            document.getElementById('submitBtn').classList.toggle('hidden', currentStep !== totalSteps);
        }

        // --- Form Rendering Helpers ---

        function addImageField(containerId, value = '') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'flex space-x-2 group';
            div.innerHTML = `
                <input type="text" value="${value}" placeholder="Link ảnh (https://...)" class="flex-1 px-4 py-2 rounded-lg border border-gray-100 text-xs focus:border-primary outline-none">
                <button type="button" onclick="this.parentElement.remove()" class="p-2 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            `;
            container.appendChild(div);
            lucide.createIcons();
        }

        function addItineraryDay(data = null) {
            const container = document.getElementById('itinerary-days-container');
            const dayDiv = document.createElement('div');
            dayDiv.className = 'bg-gray-50/50 p-6 rounded-2xl border border-gray-100 space-y-4';

            dayDiv.innerHTML = `
                <div class="flex space-x-4">
                    <div class="w-24">
                        <label class="block text-[10px] font-bold text-gray-400 mb-1">NGÀY</label>
                        <input type="text" value="${data ? data.day : 'Ngày 1'}" class="tour-itinerary-day-label w-full px-3 py-2 rounded-lg border bg-white font-bold text-sm">
                    </div>
                    <div class="flex-1">
                        <label class="block text-[10px] font-bold text-gray-400 mb-1">TIÊU ĐỀ NGÀY</label>
                        <input type="text" value="${data ? data.title : 'Hành trình bắt đầu'}" class="tour-itinerary-day-title w-full px-3 py-2 rounded-lg border bg-white font-bold text-sm">
                    </div>
                    <button type="button" onclick="this.closest('.bg-gray-50\\/50').remove()" class="mt-6 text-gray-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
                <div class="tour-day-events-container space-y-2">
                    <!-- Events here -->
                </div>
                <button type="button" onclick="addItineraryEvent(this.parentElement.querySelector('.tour-day-events-container'))" class="text-[10px] font-bold text-primary">+ THÊM HOẠT ĐỘNG</button>
            `;
            container.appendChild(dayDiv);

            const eventsCont = dayDiv.querySelector('.tour-day-events-container');
            if (data && data.events) {
                data.events.forEach(e => addItineraryEvent(eventsCont, e));
            } else {
                addItineraryEvent(eventsCont);
            }
            lucide.createIcons();
        }

        function addItineraryEvent(container, val = '') {
            const row = document.createElement('div');
            row.className = 'flex space-x-2 group items-center';
            let time = '', content = val;
            if (val.includes(': ')) {
                [time, content] = val.split(': ');
            }
            row.innerHTML = `
                <input type="text" value="${time}" placeholder="8h00" class="tour-event-time w-20 px-3 py-1.5 rounded-lg border bg-white text-xs">
                <input type="text" value="${content}" placeholder="Ăn sáng và khởi hành" class="tour-event-content flex-1 px-3 py-1.5 rounded-lg border bg-white text-xs">
                <button type="button" onclick="this.parentElement.remove()" class="p-1.5 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><i data-lucide="x" class="w-3 h-3"></i></button>
            `;
            container.appendChild(row);
            lucide.createIcons();
        }

        function renderInclusionsGrid() {
            const grid = document.getElementById('inclusions-grid');
            grid.innerHTML = '';
            DEFAULT_INCLUSIONS.forEach(item => {
                const div = document.createElement('div');
                div.className = 'inclusion-item p-4 rounded-2xl border border-gray-100 hover:border-primary/20 transition-all bg-white relative';
                div.innerHTML = `
                    <label class="flex items-start cursor-pointer">
                        <input type="checkbox" id="inc-${item.id}" class="mt-1 mr-3 h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary" onchange="toggleInclusionStyle(this)">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-1">
                                <i data-lucide="${item.icon}" class="inclusion-icon w-4 h-4 text-primary grayscale opacity-50"></i>
                                <span class="text-xs font-bold text-gray-800">${item.title}</span>
                            </div>
                            <textarea rows="2" class="w-full bg-transparent text-[10px] text-gray-500 border-none p-0 outline-none resize-none overflow-hidden" placeholder="Mô tả chi tiết...">${item.desc}</textarea>
                        </div>
                    </label>
                `;
                grid.appendChild(div);
            });
            lucide.createIcons();
        }

        function toggleInclusionStyle(cb) {
            const div = cb.closest('.inclusion-item');
            const icon = div.querySelector('.inclusion-icon');
            if (cb.checked) {
                div.classList.add('bg-primary/5', 'border-primary/20');
                icon.classList.remove('grayscale', 'opacity-50');
            } else {
                div.classList.remove('bg-primary/5', 'border-primary/20');
                icon.classList.add('grayscale', 'opacity-50');
            }
        }

        function addExclusionRow(data = null) {
            const container = document.getElementById('exclusions-container');
            const row = document.createElement('div');
            row.className = 'flex space-x-3 group';
            row.innerHTML = `
                <input type="text" value="${data ? data.title : ''}" placeholder="Tiêu đề (VD: Chi phí cá nhân)" class="tour-exclusion-title w-1/3 px-4 py-2 rounded-xl border border-gray-100 text-xs">
                <input type="text" value="${data ? data.content : ''}" placeholder="Mô tả (VD: Cà phê, nước ngọt ngoài chương trình...)" class="tour-exclusion-content flex-1 px-4 py-2 rounded-xl border border-gray-100 text-xs">
                <button type="button" onclick="this.parentElement.remove()" class="p-2 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"><i data-lucide="x" class="w-4 h-4"></i></button>
            `;
            container.appendChild(row);
            lucide.createIcons();
        }

        // --- Logic Handlers ---

        async function loadTourForEdit(id) {
            try {
                const res = await fetch(`/.netlify/functions/get-tours`);
                const tours = await res.json();
                const tour = tours.find(t => t.id == id);
                if (!tour) return;

                document.getElementById('edit-id').value = tour.id;
                document.getElementById('tour-name').value = tour.name;
                document.getElementById('tour-slug').value = tour.slug;
                document.getElementById('tour-hero-image').value = tour.hero_image || '';
                document.getElementById('tour-short-desc').value = tour.short_desc || '';
                document.getElementById('tour-long-desc').value = tour.long_desc || '';
                document.getElementById('tour-region').value = tour.region || 'Miền Nam';
                document.getElementById('tour-type').value = tour.type || 'TREKKING';
                document.getElementById('tour-price').value = tour.price;
                document.getElementById('tour-note').value = tour.preparation || '';

                // Restore dynamic fields...
                document.getElementById('card-slideshow-container').innerHTML = '';
                const imgs = [tour.image, tour.image2, tour.image3, tour.image4].filter(v => v);
                imgs.forEach(img => addImageField('card-slideshow-container', img));

                document.getElementById('detail-gallery-container').innerHTML = '';
                if (tour.gallery) tour.gallery.forEach(img => addImageField('detail-gallery-container', img));

                // Specs
                const s = tour.specs || {};
                document.getElementById('spec-location').value = s.location || '';
                document.getElementById('spec-duration').value = s.duration || '';
                document.getElementById('spec-distance').value = s.distance || '';
                document.getElementById('spec-elevation').value = s.elevation || '';
                document.getElementById('spec-difficulty').value = s.difficulty || '';
                document.getElementById('spec-transport').value = s.transport || '';
                document.getElementById('spec-quantity').value = s.quantity || '';
                document.getElementById('spec-guide-ratio').value = s.guide_ratio || '';

                // Itinerary
                document.getElementById('itinerary-days-container').innerHTML = '';
                if (tour.itinerary) tour.itinerary.forEach(d => addItineraryDay(d));

                // Exclusions
                document.getElementById('exclusions-container').innerHTML = '';
                if (tour.exclusions) tour.exclusions.forEach(ex => addExclusionRow(ex));

                // Inclusions
                if (tour.inclusions) {
                    tour.inclusions.forEach(inc => {
                        const cb = document.getElementById(`inc-${inc.id}`);
                        if (cb) {
                            cb.checked = true;
                            cb.closest('.inclusion-item').querySelector('textarea').value = inc.desc;
                            toggleInclusionStyle(cb);
                        }
                    });
                }

                document.querySelector('h1').innerText = 'Chỉnh sửa: ' + tour.name;
            } catch (err) {
                console.error(err);
            }
        }

        async function saveTour(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerText;
            submitBtn.disabled = true;
            submitBtn.innerText = 'Đang lưu PRO MAX...';

            const cardImages = Array.from(document.getElementById('card-slideshow-container').querySelectorAll('input')).map(i => i.value).filter(v => v);
            const galleryImages = Array.from(document.getElementById('detail-gallery-container').querySelectorAll('input')).map(i => i.value).filter(v => v);

            const itinerary = Array.from(document.getElementById('itinerary-days-container').children).map(div => {
                const day = div.querySelector('.tour-itinerary-day-label').value;
                const title = div.querySelector('.tour-itinerary-day-title').value;
                const events = Array.from(div.querySelectorAll('.tour-day-events-container div')).map(e => {
                    const t = e.querySelector('.tour-event-time').value;
                    const c = e.querySelector('.tour-event-content').value;
                    return t ? `${t}: ${c}` : c;
                }).filter(v => v);
                return { day, title, events };
            });

            const inclusions = [];
            DEFAULT_INCLUSIONS.forEach(item => {
                const cb = document.getElementById(`inc-${item.id}`);
                if (cb.checked) {
                    const desc = cb.closest('.inclusion-item').querySelector('textarea').value;
                    inclusions.push({ id: item.id, title: item.title, icon: item.icon, desc });
                }
            });

            const exclusions = Array.from(document.getElementById('exclusions-container').children).map(row => ({
                title: row.querySelector('.tour-exclusion-title').value,
                content: row.querySelector('.tour-exclusion-content').value
            })).filter(v => v.title);

            const id = document.getElementById('edit-id').value;
            const tour = {
                id: id ? parseInt(id) : null,
                name: document.getElementById('tour-name').value,
                slug: document.getElementById('tour-slug').value,
                image: cardImages[0] || '',
                image2: cardImages[1] || '',
                image3: cardImages[2] || '',
                image4: cardImages[3] || '',
                hero_image: document.getElementById('tour-hero-image').value,
                short_desc: document.getElementById('tour-short-desc').value,
                long_desc: document.getElementById('tour-long-desc').value,
                region: document.getElementById('tour-region').value,
                type: document.getElementById('tour-type').value,
                price: parseInt(document.getElementById('tour-price').value),
                specs: {
                    location: document.getElementById('spec-location').value,
                    duration: document.getElementById('spec-duration').value,
                    distance: document.getElementById('spec-distance').value,
                    elevation: document.getElementById('spec-elevation').value,
                    difficulty: document.getElementById('spec-difficulty').value,
                    transport: document.getElementById('spec-transport').value,
                    quantity: document.getElementById('spec-quantity').value,
                    guide_ratio: document.getElementById('spec-guide-ratio').value
                },
                itinerary, inclusions, exclusions,
                preparation: document.getElementById('tour-note').value,
                gallery: galleryImages
            };

            try {
                const res = await fetch('/.netlify/functions/save-tour', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(tour)
                });
                if (!res.ok) throw new Error('Không thể lưu Tour');
                alert('Khởi tạo hành trình PRO MAX thành công!');
                window.location.href = '/ADMIN/tours.html';
            } catch (err) {
                alert('Lỗi: ' + err.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerText = originalText;
            }
        }

        // Auto Slug
        document.getElementById('tour-name').addEventListener('input', (e) => {
            if (document.getElementById('edit-id').value) return;
            const slug = e.target.value.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[đĐ]/g, 'd')
                .replace(/([^0-9a-z-\s])/g, '').replace(/(\s+)/g, '-').replace(/-+/g, '-').replace(/^-+|-+$/g, '');
            document.getElementById('tour-slug').value = slug;
        });

        init();
    </script>
</body>

</html>