<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Tour - CAM SITE RETREATS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="../js/auth.js"></script> <!-- Auth Logic -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#E85D04',
                        secondary: '#FFF8F0',
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --primary: #E85D04;
            --bg-dashboard: #F8F9FA;
            --sidebar-width: 260px;
        }

        html {
            font-size: 18px;
        }

        @media (max-width: 768px) {
            html {
                font-size: 13px !important;
            }

            h1,
            h2,
            h3 {
                font-size: 15px !important;
                line-height: 1.4 !important;
            }
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-dashboard);
        }

        .sidebar {
            width: var(--sidebar-width);
            transition: all 0.3s ease;
        }

        .nav-link.active {
            background-color: rgba(232, 93, 4, 0.1);
            color: var(--primary);
            border-left: 4px solid var(--primary);
        }
    </style>
</head>

<body class="flex min-h-screen">

    <!-- Sidebar -->
    <aside class="sidebar fixed h-full bg-white border-r border-gray-100 flex flex-col z-40">
        <div class="p-6 border-b border-gray-100">
            <a href="../index.html" class="block">
                <img src="../logo.png" alt="CAM SITE RETREATS" class="h-14 w-auto object-contain">
                <span class="text-[10px] text-gray-400 block mt-1 font-bold uppercase tracking-widest">Admin
                    Panel</span>
            </a>
        </div>

        <nav class="flex-1 mt-6 px-4 space-y-2">
            <a href="dashboard.html"
                class="nav-link flex items-center space-x-3 p-3 rounded-xl font-medium transition-all group text-[15px] text-gray-500 hover:bg-gray-50">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span>Tổng quan</span>
            </a>
            <a href="tours.html"
                class="nav-link active flex items-center space-x-3 p-3 rounded-xl font-medium transition-all text-[15px]">
                <i data-lucide="package" class="w-5 h-5"></i>
                <span>Quản lý Tour</span>
            </a>
            <a href="schedules.html"
                class="nav-link text-[15px] text-gray-500 hover:bg-gray-50 flex items-center space-x-3 p-3 rounded-xl font-medium transition-all">
                <i data-lucide="calendar" class="w-5 h-5"></i>
                <span>Lịch trình Tour</span>
            </a>
            <a href="leads.html"
                class="nav-link text-[15px] text-gray-500 hover:bg-gray-50 flex items-center space-x-3 p-3 rounded-xl font-medium transition-all">
                <i data-lucide="message-square" class="w-5 h-5"></i>
                <span>Khách hàng đăng ký tư vấn</span>
                <span id="leads-badge-count" class="bg-primary text-white text-[10px] px-2 py-1 rounded-full ml-auto"
                    style="display: none;">0</span>
            </a>
            <a href="bookings.html"
                class="nav-link text-[15px] text-gray-500 hover:bg-gray-50 flex items-center space-x-3 p-3 rounded-xl font-medium transition-all">
                <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                <span>Khách hàng đã đăng ký</span>
                <span id="bookings-badge-count"
                    class="bg-green-500 text-white text-[10px] px-2 py-1 rounded-full ml-auto"
                    style="display: none;">0</span>
            </a>
            <a href="users.html" id="nav-users"
                class="nav-link text-[15px] text-gray-500 hover:bg-gray-50 flex items-center space-x-3 p-3 rounded-xl font-medium transition-all">
                <i data-lucide="users-2" class="w-5 h-5"></i>
                <span>Quản lý User</span>
            </a>
            <a href="customers.html"
                class="nav-link text-[15px] text-gray-500 hover:bg-gray-50 flex items-center space-x-3 p-3 rounded-xl font-medium transition-all">
                <i data-lucide="users" class="w-5 h-5"></i>
                <span>Khách hàng</span>
            </a>
            <a href="reports.html"
                class="nav-link text-[15px] text-gray-500 hover:bg-gray-50 flex items-center space-x-3 p-3 rounded-xl font-medium transition-all">
                <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                <span>Báo cáo</span>
            </a>
        </nav>

        <div class="p-6 border-t border-gray-100">
            <div class="flex items-center gap-3 mb-4 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition-colors"
                onclick="window.location.href='profile.html'">
                <img id="sidebar-avatar" src="" class="w-8 h-8 rounded-full border border-gray-200">
                <div class="flex-1 min-w-0">
                    <p id="sidebar-name" class="text-xs font-bold text-gray-800 truncate">User</p>
                    <p id="sidebar-role" class="text-[10px] text-gray-500 uppercase">Role</p>
                </div>
            </div>
            <button onclick="logout()"
                class="w-full flex items-center space-x-3 p-3 rounded-xl font-medium text-red-500 hover:bg-red-50 transition-all">
                <i data-lucide="log-out" class="w-5 h-5"></i>
                <span>Đăng xuất</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 ml-[260px] p-8">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Quản lý Hành Trình</h1>
                <p class="text-gray-500 text-sm">Cập nhật và chỉnh sửa thông tin các tour trekking.</p>
            </div>
            <button id="btn-add-tour" onclick="window.location.href='add-tour.html'"
                class="bg-primary text-white px-6 py-3 rounded-xl font-bold flex items-center space-x-2 shadow-lg shadow-primary/20 hover:scale-105 active:scale-95 transition-all">
                <i data-lucide="plus" class="w-5 h-5"></i>
                <span>Thêm tour mới</span>
            </button>
        </header>

        <!-- Quản Lý Tour Table -->
        <div class="bg-white rounded-[20px] shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/30">
                <h3 class="font-black text-gray-800 uppercase tracking-tight">Danh sách Tour hiện có</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-50/50 text-gray-400 text-[10px] uppercase tracking-widest">
                        <tr>
                            <th class="px-6 py-4">Tên Tour</th>
                            <th class="px-6 py-4">Thời gian</th>
                            <th class="px-6 py-4">Giá trị</th>
                            <th class="px-6 py-4">Trạng thái</th>
                            <th class="px-6 py-4">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-50">
                        <tr class="hover:bg-gray-50/50 transition-colors">
                            <td class="px-6 py-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 rounded-lg bg-gray-100 overflow-hidden">
                                        <img src="https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&q=80&w=100"
                                            class="w-full h-full object-cover">
                                    </div>
                                    <span class="text-sm font-bold">Tà Năng - Phan Dũng</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-sm">2 Ngày 1 Đêm</td>
                            <td class="px-6 py-4 text-sm font-bold text-primary">2.690.000đ</td>
                            <td class="px-6 py-4">
                                <span
                                    class="bg-green-100 text-green-600 text-[10px] px-2 py-1 rounded-full font-bold">Hiển
                                    thị</span>
                            </td>
                            <td class="px-6 py-4">
                                <button class="text-gray-400 hover:text-primary transition-colors"><i
                                        data-lucide="edit-3" class="w-4 h-4"></i></button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tours Table already rendered above -->
    </main>

    <script>
        lucide.createIcons();
        const modal = document.getElementById('addTourModal');
        let currentUser = null;

        // Configuration for 12 Inclusions
        const DEFAULT_INCLUSIONS = [
            { id: 'xe', title: 'Xe đưa đón', icon: 'XeTrungChuyen.png', desc: 'Di chuyển bằng xe giường nằm, đưa đón 2 chiều từ TP HCM.' },
            { id: 'hdv', title: 'Hướng dẫn viên', icon: 'HuongDanVien-SuaLai.png', desc: 'Hướng dẫn viên chuyên nghiệp, dễ thương và nhiệt tình.' },
            { id: 'an_uong', title: 'Bữa ăn', icon: 'DoAn-SuaLai.png', desc: 'Gồm 6 bữa ăn: món nước, BBQ... trong suốt hành trình.' },
            { id: 'leu', title: 'Lều trại', icon: 'Leu-SuaLai.png', desc: 'Tiêu chuẩn 3 người/lều, bao gồm túi ngủ, cách nhiệt, gối hơi.' },
            { id: 'nuoc_uong', title: 'Nước uống', icon: 'NuocUong.png', desc: 'Tiêu chuẩn 1.5L / người / ngày trong suốt hành trình.' },
            { id: 'nuoc_tam', title: 'Nước tắm', icon: 'NuocTam-SuaLai_20260113000157.png', desc: 'Mỗi người được 15L nước sạch để tắm tại bãi camping rừng.' },
            { id: 'bao_hiem', title: 'Bảo hiểm', icon: 'BaoHiem.png', desc: 'Được trang bị bảo hiểm du lịch lên đến 70.000.000 đồng.' },
            { id: 'huy_chuong', title: 'Huy chương', icon: 'HuyChuong.png', desc: 'Được thiết kế đặc biệt, in tên và ngày kỷ niệm của đoàn.' },
            { id: 'gay', title: 'Gậy trekking', icon: 'GayTrekking.png', desc: 'Được hỗ trợ mượn gậy chất lượng, đảm bảo an toàn chuyến đi.' },
            { id: 'ao_mua', title: 'Áo mưa', icon: 'AoMua.png', desc: 'Áo mưa chuyên dụng, kèm túi ZIP bảo vệ quần áo bên trong.' },
            { id: 'chup_anh', title: 'Chụp ảnh', icon: 'ChupAnhCamera.png', desc: 'Chụp ảnh bằng máy cơ và hỗ trợ quay chụp bằng điện thoại.' },
            { id: 'grab', title: 'Grab rừng', icon: 'XeGrab.png', desc: 'Trải nghiệm ngồi xe máy băng rừng trong 5km hành trình cuối.' }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            currentUser = checkAuth();
            if (currentUser) {
                document.getElementById('sidebar-avatar').src = currentUser.avatar;
                document.getElementById('sidebar-name').textContent = currentUser.fullName;
                document.getElementById('sidebar-role').textContent = currentUser.role.toUpperCase();

                if (currentUser.role !== 'admin') {
                    document.getElementById('nav-users').classList.add('hidden');
                    document.getElementById('btn-add-tour').classList.add('hidden');
                }
            }

            renderInclusionsGrid();
            loadTours();
            syncBadges();
        });

        // UI Helpers
        function switchTab(tab) {
            const basicTab = document.getElementById('tab-basic');
            const detailTab = document.getElementById('tab-detail');
            const btnBasic = document.getElementById('tab-btn-basic');
            const btnDetail = document.getElementById('tab-btn-detail');

            if (tab === 'basic') {
                basicTab.classList.remove('hidden');
                detailTab.classList.add('hidden');
                btnBasic.classList.add('border-primary', 'text-primary');
                btnBasic.classList.remove('border-transparent', 'text-gray-400');
                btnDetail.classList.add('border-transparent', 'text-gray-400');
                btnDetail.classList.remove('border-primary', 'text-primary');
            } else {
                basicTab.classList.add('hidden');
                detailTab.classList.remove('hidden');
                btnDetail.classList.add('border-primary', 'text-primary');
                btnDetail.classList.remove('border-transparent', 'text-gray-400');
                btnBasic.classList.add('border-transparent', 'text-gray-400');
                btnBasic.classList.remove('border-primary', 'text-primary');
            }
        }

        // Dynamic Form Logic
        function addImageField(containerId, value = '') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'relative group';
            div.innerHTML = `
                <input type="text" value="${value}" placeholder="Link ảnh..." 
                    class="w-full p-2.5 rounded-lg border border-gray-100 text-[10px] outline-none focus:border-primary">
                <button type="button" onclick="this.parentElement.remove()" 
                    class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-md opacity-0 group-hover:opacity-100 transition-opacity">
                    <i data-lucide="x" class="w-3 h-3"></i>
                </button>
            `;
            container.appendChild(div);
            lucide.createIcons();
        }

        function addItineraryDay(data = { day: '', title: '', events: [] }) {
            const container = document.getElementById('itinerary-days-container');
            const dayIdx = container.children.length;
            const dayDiv = document.createElement('div');
            dayDiv.className = 'p-6 bg-gray-50 rounded-2xl border border-gray-100 space-y-4';
            dayDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="flex gap-4">
                        <input type="text" placeholder="Ngày 0" value="${data.day || ''}" class="w-24 p-2 rounded-lg border font-bold text-sm bg-white tour-itinerary-day-label">
                        <input type="text" placeholder="Tên ngày (VD: Khởi hành)" value="${data.title || ''}" class="w-64 p-2 rounded-lg border font-bold text-sm bg-white tour-itinerary-day-title">
                    </div>
                    <button type="button" onclick="this.parentElement.parentElement.remove()" class="text-red-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
                <div class="space-y-2 tour-day-events-container">
                    <!-- Events will be added here -->
                </div>
                <button type="button" onclick="addItineraryEvent(this)" class="text-[10px] font-bold text-primary flex items-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> Thêm mốc thời gian</button>
            `;
            container.appendChild(dayDiv);

            // Add existing events if editing
            const eventsContainer = dayDiv.querySelector('.tour-day-events-container');
            if (data.events && data.events.length > 0) {
                data.events.forEach(evt => addItineraryEvent({ parentElement: { parentElement: dayDiv } }, evt));
            } else {
                // Default 2 empty rows as requested
                addItineraryEvent({ parentElement: { parentElement: dayDiv } });
                addItineraryEvent({ parentElement: { parentElement: dayDiv } });
            }
            lucide.createIcons();
        }

        function addItineraryEvent(btn, value = '') {
            const row = document.createElement('div');
            row.className = 'flex gap-2 group items-center';

            // Split value into time and content if it contains ":"
            let time = '', content = '';
            if (value.includes(':')) {
                const parts = value.split(':');
                time = parts[0].trim();
                content = parts.slice(1).join(':').trim();
            } else {
                content = value;
            }

            row.innerHTML = `
                <input type="text" placeholder="21h45" value="${time}" class="w-20 p-2 rounded-lg border text-xs bg-white tour-event-time">
                <input type="text" placeholder="Nội dung công việc..." value="${content}" class="flex-1 p-2 rounded-lg border text-xs bg-white tour-event-content">
                <button type="button" onclick="this.parentElement.remove()" class="opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 transition-opacity"><i data-lucide="x" class="w-3 h-3"></i></button>
            `;

            // Support both direct parent (when adding) and delegated parent (when initial load)
            const list = btn.querySelector ? btn.querySelector('.tour-day-events-container') : btn.closest('.p-6').querySelector('.tour-day-events-container');
            list.appendChild(row);
            lucide.createIcons();
        }

        function renderInclusionsGrid() {
            const grid = document.getElementById('inclusions-grid');
            grid.innerHTML = '';
            DEFAULT_INCLUSIONS.forEach(item => {
                const div = document.createElement('div');
                div.className = 'inclusion-item p-3 border border-gray-100 rounded-xl flex items-start gap-3 bg-white hover:border-primary/30 transition-all cursor-pointer';
                div.onclick = () => {
                    const checkbox = div.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    div.classList.toggle('bg-primary/5', checkbox.checked);
                    div.classList.toggle('border-primary/20', checkbox.checked);
                    const icon = div.querySelector('.inclusion-icon');
                    icon.classList.toggle('grayscale', !checkbox.checked);
                    icon.classList.toggle('opacity-50', !checkbox.checked);
                };
                div.innerHTML = `
                    <input type="checkbox" id="inc-${item.id}" value="${item.id}" class="mt-1 accent-primary" onclick="event.stopPropagation()">
                    <div class="shrink-0 w-10 h-10 border border-gray-50 rounded-lg p-1">
                        <img src="../${item.icon}" class="w-full h-full object-contain grayscale opacity-50 inclusion-icon">
                    </div>
                    <div>
                        <h4 class="text-[10px] font-black uppercase text-gray-800">${item.title}</h4>
                        <textarea class="w-full mt-1 p-1 text-[9px] text-gray-400 bg-transparent border-none outline-none resize-none font-medium h-10" onclick="event.stopPropagation()">${item.desc}</textarea>
                    </div>
                `;
                grid.appendChild(div);

                const cb = div.querySelector('input');
                cb.addEventListener('change', () => {
                    const icon = div.querySelector('.inclusion-icon');
                    icon.classList.toggle('grayscale', !cb.checked);
                    icon.classList.toggle('opacity-50', !cb.checked);
                    div.classList.toggle('bg-primary/5', cb.checked);
                    div.classList.toggle('border-primary/20', cb.checked);
                });
            });
        }

        function addExclusionRow(data = { title: '', content: '' }) {
            const container = document.getElementById('exclusions-container');
            const row = document.createElement('div');
            row.className = 'flex gap-3 group items-start bg-red-50/30 p-3 rounded-xl border border-red-100';
            row.innerHTML = `
                <div class="flex-1 space-y-2">
                    <input type="text" placeholder="Tiêu đề (VD: Gửi đồ lên bãi trại)" value="${data.title || ''}" class="w-full p-2 rounded-lg border text-xs font-bold tour-exclusion-title">
                    <input type="text" placeholder="Mô tả (VD: Mức giá 100k / balo...)" value="${data.content || ''}" class="w-full p-2 rounded-lg border text-xs text-gray-500 tour-exclusion-content">
                </div>
                <button type="button" onclick="this.parentElement.remove()" class="text-gray-300 hover:text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            `;
            container.appendChild(row);
            lucide.createIcons();
        }

        // --- Core Logic ---
        function syncBadges() {
            const LEADS_KEY = 'cam_site_leads';
            const BOOKINGS_KEY = 'cam_site_bookings';
            const leads = JSON.parse(localStorage.getItem(LEADS_KEY)) || [];
            const bookings = JSON.parse(localStorage.getItem(BOOKINGS_KEY)) || [];
            const pendingLeads = leads.filter(l => l.status === 'Chờ tư vấn').length;
            const lBadge = document.getElementById('leads-badge-count');
            if (lBadge) {
                lBadge.textContent = pendingLeads;
                lBadge.style.display = pendingLeads > 0 ? 'inline-block' : 'none';
            }
            const bBadge = document.getElementById('bookings-badge-count');
            if (bBadge) {
                bBadge.textContent = bookings.length;
                bBadge.style.display = bookings.length > 0 ? 'inline-block' : 'none';
            }
        }

        async function loadTours() {
            const tableBody = document.querySelector('tbody');
            tableBody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Đang tải dữ liệu...</td></tr>';

            try {
                const response = await fetch(`/api/get-tours?t=${Date.now()}`);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.details || data.error);
                }

                tableBody.innerHTML = '';
                if (!Array.isArray(data) || data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Chưa có tour nào.</td></tr>';
                } else {
                    data.sort((a, b) => b.id - a.id).forEach(item => renderRow(item));
                }
            } catch (error) {
                console.error('Error loading tours:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="p-8 text-center">
                            <p class="text-red-500 font-bold">Lỗi khi tải dữ liệu từ Database</p>
                            <p class="text-[10px] text-gray-400 mt-1">${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }

        function renderRow(item) {
            const tableBody = document.querySelector('tbody');
            let actionButtons = '';
            if (currentUser && currentUser.role === 'admin') {
                actionButtons = `
                    <button onclick="window.location.href='add-tour.html?id=${item.id}'" class="text-gray-400 hover:text-primary transition-colors">
                        <i data-lucide="edit-3" class="w-4 h-4"></i>
                    </button>
                    <button onclick="deleteTour(${item.id})" class="text-gray-400 hover:text-red-500 transition-colors">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
            } else {
                actionButtons = `<span class="text-gray-300 text-xs italic">Chỉ xem</span>`;
            }

            const newRow = `
                <tr class="hover:bg-gray-50/50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-lg bg-gray-100 overflow-hidden">
                                <img src="${item.image}" class="w-full h-full object-cover">
                            </div>
                            <div>
                                <span class="text-sm font-bold block">${item.name}</span>
                                <span class="text-[10px] text-gray-400 font-mono">/tour/${item.slug}</span>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-sm">${item.duration}</td>
                    <td class="px-6 py-4 text-sm font-bold text-primary">${parseInt(item.price).toLocaleString('vi-VN')}đ</td>
                    <td class="px-6 py-4">
                        <span class="bg-green-100 text-green-600 text-[10px] px-2 py-1 rounded-full font-bold">Hoạt động</span>
                    </td>
                    <td class="px-6 py-4 space-x-2">${actionButtons}</td>
                </tr>
            `;
            tableBody.insertAdjacentHTML('beforeend', newRow);
            lucide.createIcons();
        }

        async function saveTour(event) {
            // Placeholder potentially unused in this page now
        }

        async function deleteTour(id) {
            if (confirm('Bạn chắc chắn muốn xóa Tour này? Hành động này không thể hoàn tác.')) {
                try {
                    const response = await fetch(`/api/save-tour?id=${id}&t=${Date.now()}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('Không thể xóa tour.');
                    alert('Đã xóa dữ liệu thành công.');
                    loadTours();
                } catch (error) {
                    alert('Lỗi: ' + error.message);
                }
            }
        }
    </script>
</body>

</html>