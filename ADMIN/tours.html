<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Tour - CAM SITE RETREATS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="../js/auth.js"></script> <!-- Auth Logic -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#E85D04',
                        secondary: '#FFF8F0',
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --primary: #E85D04;
            --bg-dashboard: #F8F9FA;
            --sidebar-width: 260px;
        }

        html {
            font-size: 18px;
        }

        @media (max-width: 768px) {
            html {
                font-size: 13px !important;
            }

            h1,
            h2,
            h3 {
                font-size: 15px !important;
                line-height: 1.4 !important;
            }
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-dashboard);
        }

        .sidebar {
            width: var(--sidebar-width);
            transition: all 0.3s ease;
        }

        .nav-link.active {
            background-color: rgba(232, 93, 4, 0.1);
            color: var(--primary);
            border-left: 4px solid var(--primary);
        }
    </style>
</head>

<body class="flex min-h-screen">

    <!-- Sidebar -->
    <aside class="sidebar fixed h-full bg-white border-r border-gray-100 flex flex-col z-40">
        <div class="p-6 border-b border-gray-100">
            <a href="../index.html" class="block">
                <img src="../logo.png" alt="CAM SITE RETREATS" class="h-14 w-auto object-contain">
                <span class="text-[10px] text-gray-400 block mt-1 font-bold uppercase tracking-widest">Admin
                    Panel</span>
            </a>
        </div>

        <nav class="flex-1 mt-6 px-4 space-y-2">
            <a href="dashboard.html"
                class="nav-link flex items-center space-x-3 p-3 rounded-xl font-medium transition-all group text-[15px] text-gray-500 hover:bg-gray-50">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span>Tổng quan</span>
            </a>
            <a href="tours.html"
                class="nav-link active flex items-center space-x-3 p-3 rounded-xl font-medium transition-all text-[15px]">
                <i data-lucide="package" class="w-5 h-5"></i>
                <span>Quản lý Tour</span>
            </a>
            <a href="schedules.html"
                class="nav-link text-[15px] text-gray-500 hover:bg-gray-50 flex items-center space-x-3 p-3 rounded-xl font-medium transition-all">
                <i data-lucide="calendar" class="w-5 h-5"></i>
                <span>Lịch trình Tour</span>
            </a>
            <a href="leads.html"
                class="nav-link text-[15px] text-gray-500 hover:bg-gray-50 flex items-center space-x-3 p-3 rounded-xl font-medium transition-all">
                <i data-lucide="message-square" class="w-5 h-5"></i>
                <span>Khách hàng đăng ký tư vấn</span>
                <span id="leads-badge-count" class="bg-primary text-white text-[10px] px-2 py-1 rounded-full ml-auto"
                    style="display: none;">0</span>
            </a>
            <a href="bookings.html"
                class="nav-link text-[15px] text-gray-500 hover:bg-gray-50 flex items-center space-x-3 p-3 rounded-xl font-medium transition-all">
                <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                <span>Khách hàng đã đăng ký</span>
                <span id="bookings-badge-count"
                    class="bg-green-500 text-white text-[10px] px-2 py-1 rounded-full ml-auto"
                    style="display: none;">0</span>
            </a>
            <a href="users.html" id="nav-users"
                class="nav-link text-[15px] text-gray-500 hover:bg-gray-50 flex items-center space-x-3 p-3 rounded-xl font-medium transition-all">
                <i data-lucide="users-2" class="w-5 h-5"></i>
                <span>Quản lý User</span>
            </a>
            <a href="customers.html"
                class="nav-link text-[15px] text-gray-500 hover:bg-gray-50 flex items-center space-x-3 p-3 rounded-xl font-medium transition-all">
                <i data-lucide="users" class="w-5 h-5"></i>
                <span>Khách hàng</span>
            </a>
            <a href="reports.html"
                class="nav-link text-[15px] text-gray-500 hover:bg-gray-50 flex items-center space-x-3 p-3 rounded-xl font-medium transition-all">
                <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                <span>Báo cáo</span>
            </a>
        </nav>

        <div class="p-6 border-t border-gray-100">
            <div class="flex items-center gap-3 mb-4 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition-colors"
                onclick="window.location.href='profile.html'">
                <img id="sidebar-avatar" src="" class="w-8 h-8 rounded-full border border-gray-200">
                <div class="flex-1 min-w-0">
                    <p id="sidebar-name" class="text-xs font-bold text-gray-800 truncate">User</p>
                    <p id="sidebar-role" class="text-[10px] text-gray-500 uppercase">Role</p>
                </div>
            </div>
            <button onclick="logout()"
                class="w-full flex items-center space-x-3 p-3 rounded-xl font-medium text-red-500 hover:bg-red-50 transition-all">
                <i data-lucide="log-out" class="w-5 h-5"></i>
                <span>Đăng xuất</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 ml-[260px] p-8">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Quản lý Hành Trình</h1>
                <p class="text-gray-500 text-sm">Cập nhật và chỉnh sửa thông tin các tour trekking.</p>
            </div>
            <button id="btn-add-tour" onclick="openAddTourModal()"
                class="bg-primary text-white px-6 py-3 rounded-xl font-bold flex items-center space-x-2 shadow-lg shadow-primary/20 hover:scale-105 active:scale-95 transition-all">
                <i data-lucide="plus" class="w-5 h-5"></i>
                <span>Thêm tour mới</span>
            </button>
        </header>

        <!-- Quản Lý Tour Table -->
        <div class="bg-white rounded-[20px] shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/30">
                <h3 class="font-black text-gray-800 uppercase tracking-tight">Danh sách Tour hiện có</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-50/50 text-gray-400 text-[10px] uppercase tracking-widest">
                        <tr>
                            <th class="px-6 py-4">Tên Tour</th>
                            <th class="px-6 py-4">Thời gian</th>
                            <th class="px-6 py-4">Giá trị</th>
                            <th class="px-6 py-4">Trạng thái</th>
                            <th class="px-6 py-4">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-50">
                        <tr class="hover:bg-gray-50/50 transition-colors">
                            <td class="px-6 py-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 rounded-lg bg-gray-100 overflow-hidden">
                                        <img src="https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&q=80&w=100"
                                            class="w-full h-full object-cover">
                                    </div>
                                    <span class="text-sm font-bold">Tà Năng - Phan Dũng</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-sm">2 Ngày 1 Đêm</td>
                            <td class="px-6 py-4 text-sm font-bold text-primary">2.690.000đ</td>
                            <td class="px-6 py-4">
                                <span
                                    class="bg-green-100 text-green-600 text-[10px] px-2 py-1 rounded-full font-bold">Hiển
                                    thị</span>
                            </td>
                            <td class="px-6 py-4">
                                <button class="text-gray-400 hover:text-primary transition-colors"><i
                                        data-lucide="edit-3" class="w-4 h-4"></i></button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Add Tour Modal -->
        <div id="addTourModal"
            class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden backdrop-blur-sm">
            <div
                class="bg-white w-full max-w-5xl h-[90vh] rounded-[32px] overflow-hidden shadow-2xl flex flex-col animate__animated animate__zoomIn">
                <!-- Modal Header -->
                <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-white shrink-0">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Thêm Tour Mới</h2>
                        <p class="text-xs text-gray-400 font-medium">Cấu hình thông tin hiển thị và nội dung chi tiết
                            hành trình.</p>
                    </div>
                    <button onclick="closeAddTourModal()" class="text-gray-400 hover:text-red-500 transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <!-- Tabs Navigation -->
                <div class="flex px-8 bg-gray-50/50 border-b border-gray-100 shrink-0">
                    <button type="button" onclick="switchTab('basic')" id="tab-btn-basic"
                        class="px-6 py-4 font-bold text-sm border-b-2 border-primary text-primary transition-all">
                        PHẦN 1: THÔNG TIN HIỂN THỊ
                    </button>
                    <button type="button" onclick="switchTab('detail')" id="tab-btn-detail"
                        class="px-6 py-4 font-bold text-sm border-b-2 border-transparent text-gray-400 hover:text-gray-600 transition-all">
                        PHẦN 2: NỘI DUNG CHI TIẾT
                    </button>
                </div>

                <!-- Modal Body (Scrollable) -->
                <div class="flex-1 overflow-y-auto p-8 custom-scrollbar">
                    <form id="addTourForm" class="space-y-10" onsubmit="saveTour(event)">
                        <input type="hidden" id="edit-id">

                        <!-- TAB 1: BASIC INFO -->
                        <div id="tab-basic" class="space-y-8">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label
                                        class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-2">Tên
                                        Tour</label>
                                    <input type="text" id="tour-name" placeholder="VD: Tà Năng Phan Dũng" required
                                        class="w-full px-4 py-3 rounded-xl border border-gray-100 focus:border-primary outline-none transition-all font-bold text-gray-800 bg-gray-50/50 focus:bg-white">
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-2">Đường
                                        dẫn Tour (Slug)</label>
                                    <div class="flex items-center">
                                        <span
                                            class="bg-gray-100 px-3 py-3 rounded-l-xl border border-r-0 border-gray-100 text-gray-400 text-sm">/tour/</span>
                                        <input type="text" id="tour-slug" placeholder="ta-nang-phan-dung" required
                                            class="flex-1 px-4 py-3 rounded-r-xl border border-gray-100 focus:border-primary outline-none transition-all font-bold text-primary bg-gray-50/50 focus:bg-white">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-2">Mô
                                    tả ngắn (Hiển thị ở ô Tour)</label>
                                <textarea id="tour-short-desc" placeholder="Nhập mô tả ngắn gọn thu hút khách hàng..."
                                    rows="2"
                                    class="w-full px-4 py-3 rounded-xl border border-gray-100 focus:border-primary outline-none transition-all bg-gray-50/50 focus:bg-white"></textarea>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-xs font-black text-gray-400 uppercase mb-2">Độ cao</label>
                                    <input type="text" id="tour-altitude" placeholder="1.100M"
                                        class="w-full px-4 py-3 rounded-xl border border-gray-100 focus:border-primary outline-none text-sm font-bold">
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-gray-400 uppercase mb-2">Cấp độ</label>
                                    <select id="tour-level"
                                        class="w-full px-4 py-3 rounded-xl border border-gray-100 outline-none font-bold text-sm">
                                        <option value="Dễ">Dễ</option>
                                        <option value="Trung Bình" selected>Trung Bình</option>
                                        <option value="Khó">Khó</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-gray-400 uppercase mb-2">Miền</label>
                                    <select id="tour-region"
                                        class="w-full px-4 py-3 rounded-xl border border-gray-100 outline-none font-bold text-sm">
                                        <option value="Miền Nam" selected>Miền Nam</option>
                                        <option value="Miền Trung">Miền Trung</option>
                                        <option value="Miền Bắc">Miền Bắc</option>
                                        <option value="Tây Nguyên">Tây Nguyên</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-gray-400 uppercase mb-2">Thể
                                        loại</label>
                                    <select id="tour-type"
                                        class="w-full px-4 py-3 rounded-xl border border-gray-100 outline-none font-bold text-sm">
                                        <option value="TREKKING" selected>TREKKING</option>
                                        <option value="CAMPING">CAMPING</option>
                                        <option value="RELAX">RELAX</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-gray-400 uppercase mb-2">Thời
                                        gian</label>
                                    <input type="text" id="tour-duration" placeholder="2 Ngày 1 Đêm" required
                                        class="w-full px-4 py-3 rounded-xl border border-gray-100 focus:border-primary outline-none text-sm font-bold">
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-gray-400 uppercase mb-2">Giá tiền
                                        (VNĐ)</label>
                                    <input type="number" id="tour-price" placeholder="2690000" required
                                        class="w-full px-4 py-3 rounded-xl border border-gray-100 focus:border-primary outline-none text-sm font-bold text-primary">
                                </div>
                            </div>

                            <!-- Thumbnail & Slideshow Card -->
                            <div class="space-y-4">
                                <label class="block text-xs font-black text-gray-400 uppercase tracking-widest">Hình ảnh
                                    ô Tour (Slideshow)</label>
                                <div id="card-slideshow-container" class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                    <!-- Dynamic Image Inputs -->
                                </div>
                                <button type="button" onclick="addImageField('card-slideshow-container')"
                                    class="text-xs font-bold text-primary flex items-center gap-2 hover:underline">
                                    <i data-lucide="plus-circle" class="w-4 h-4"></i> Thêm ảnh Slideshow
                                </button>
                            </div>
                        </div>

                        <!-- TAB 2: DETAIL CONTENT -->
                        <div id="tab-detail" class="hidden space-y-10">
                            <!-- Hero & Social -->
                            <div
                                class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6 bg-primary/5 rounded-[24px] border border-primary/10">
                                <div>
                                    <label
                                        class="block text-xs font-black text-primary uppercase tracking-widest mb-2">Ảnh
                                        bìa trang (Hero | 1920x1080)</label>
                                    <input type="text" id="tour-hero-image" placeholder="Link ảnh bìa chất lượng cao..."
                                        class="w-full px-4 py-3 rounded-xl border border-gray-100 focus:border-primary outline-none text-sm font-medium">
                                    <p class="text-[10px] text-gray-400 mt-2 font-medium italic">* Ảnh này cũng dùng để
                                        hiển thị khi gửi link qua Zalo/Facebook (Social Preview).</p>
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-black text-primary uppercase tracking-widest mb-2">Giới
                                        thiệu chung</label>
                                    <textarea id="tour-long-desc" placeholder="Giới thiệu sâu về hành trình..." rows="4"
                                        class="w-full px-4 py-3 rounded-xl border border-gray-100 focus:border-primary outline-none text-sm"></textarea>
                                </div>
                            </div>

                            <!-- Detailed Specs (8 Items) -->
                            <div class="space-y-4">
                                <h3
                                    class="text-sm font-black text-gray-800 uppercase tracking-tight flex items-center gap-2">
                                    <i data-lucide="info" class="w-4 h-4 text-primary"></i> Thông tin liên quan
                                </h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div>
                                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Địa
                                            điểm</label>
                                        <input type="text" id="spec-location"
                                            class="w-full p-2.5 rounded-lg border border-gray-100 text-xs font-bold"
                                            placeholder="Lâm Đồng - Bình Thuận">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Thời
                                            gian</label>
                                        <input type="text" id="spec-duration"
                                            class="w-full p-2.5 rounded-lg border border-gray-100 text-xs font-bold"
                                            placeholder="2 Ngày 1 Đêm">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Độ
                                            dài</label>
                                        <input type="text" id="spec-distance"
                                            class="w-full p-2.5 rounded-lg border border-gray-100 text-xs font-bold"
                                            placeholder="30km">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Độ
                                            cao</label>
                                        <input type="text" id="spec-elevation"
                                            class="w-full p-2.5 rounded-lg border border-gray-100 text-xs font-bold"
                                            placeholder="~900m">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Độ
                                            khó</label>
                                        <input type="text" id="spec-difficulty"
                                            class="w-full p-2.5 rounded-lg border border-gray-100 text-xs font-bold"
                                            placeholder="Trung bình">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Phương
                                            tiện</label>
                                        <input type="text" id="spec-transport"
                                            class="w-full p-2.5 rounded-lg border border-gray-100 text-xs font-bold"
                                            placeholder="Xe giường nằm">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Số
                                            lượng</label>
                                        <input type="text" id="spec-quantity"
                                            class="w-full p-2.5 rounded-lg border border-gray-100 text-xs font-bold"
                                            placeholder="Tối đa 15 khách">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Tỷ lệ
                                            HDV</label>
                                        <input type="text" id="spec-guide-ratio"
                                            class="w-full p-2.5 rounded-lg border border-gray-100 text-xs font-bold"
                                            placeholder="1 HDV / 4 Khách">
                                    </div>
                                </div>
                            </div>

                            <!-- Itinerary (Dynamic) -->
                            <div class="space-y-4">
                                <h3
                                    class="text-sm font-black text-gray-800 uppercase tracking-tight flex items-center gap-2">
                                    <i data-lucide="map" class="w-4 h-4 text-primary"></i> Lịch trình chi tiết
                                </h3>
                                <div id="itinerary-days-container" class="space-y-6">
                                    <!-- Dynamic Days -->
                                </div>
                                <button type="button" onclick="addItineraryDay()"
                                    class="bg-gray-100 text-gray-600 px-6 py-3 rounded-xl text-xs font-bold hover:bg-gray-200 transition-all flex items-center gap-2">
                                    <i data-lucide="calendar-plus" class="w-4 h-4"></i> Thêm Ngày
                                </button>
                            </div>

                            <!-- Note -->
                            <div>
                                <label class="block text-xs font-black text-gray-400 uppercase mb-2">Lưu ý nhỏ</label>
                                <textarea id="tour-note" placeholder="Các lưu ý đặc biệt..." rows="2"
                                    class="w-full px-4 py-3 rounded-xl border border-gray-100 focus:border-primary outline-none text-sm font-medium italic"></textarea>
                            </div>

                            <!-- Gallery Detail (Dynamic) -->
                            <div class="space-y-4">
                                <label class="block text-xs font-black text-gray-400 uppercase tracking-widest">Cảm xúc
                                    hành trình (Detail Gallery)</label>
                                <div id="detail-gallery-container" class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                    <!-- Dynamic Image Inputs -->
                                </div>
                                <button type="button" onclick="addImageField('detail-gallery-container')"
                                    class="text-xs font-bold text-primary flex items-center gap-2 hover:underline">
                                    <i data-lucide="plus-circle" class="w-4 h-4"></i> Thêm ảnh Gallery
                                </button>
                            </div>

                            <!-- Inclusions (12 Items) -->
                            <div class="space-y-4 pt-6 border-t border-gray-100">
                                <h3 class="text-sm font-black text-primary uppercase tracking-tight">Chi phí bao gồm (12
                                    Hạng mục)</h3>
                                <div id="inclusions-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    <!-- JS will render 12 items here -->
                                </div>
                            </div>

                            <!-- Exclusions (Dynamic Rows) -->
                            <div class="space-y-4 pt-6 border-t border-gray-100">
                                <h3 class="text-sm font-black text-red-500 uppercase tracking-tight">Chi phí KHÔNG bao
                                    gồm</h3>
                                <div id="exclusions-container" class="space-y-3">
                                    <!-- Dynamic Rows -->
                                </div>
                                <button type="button" onclick="addExclusionRow()"
                                    class="text-xs font-bold text-red-500 flex items-center gap-2 hover:underline">
                                    <i data-lucide="plus-circle" class="w-4 h-4"></i> Thêm khoản không bao gồm
                                </button>
                            </div>
                        </div>

                        <!-- Form Footer (Fixed at bottom of Modal if scrolling) -->
                        <div class="sticky bottom-0 bg-white pt-6 pb-2 border-t border-gray-100 flex gap-4">
                            <button type="button" onclick="closeAddTourModal()"
                                class="flex-1 py-4 font-bold text-gray-500 hover:bg-gray-100 rounded-2xl transition-all">Hủy</button>
                            <button type="submit" id="submit-btn"
                                class="flex-1 py-4 font-bold text-white bg-primary rounded-2xl shadow-lg shadow-primary/30 hover:scale-[1.02] active:scale-95 transition-all">Lưu
                                Hành Trình</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();
        const modal = document.getElementById('addTourModal');
        let currentUser = null;

        // Configuration for 12 Inclusions
        const DEFAULT_INCLUSIONS = [
            { id: 'xe', title: 'Xe đưa đón', icon: 'XeTrungChuyen.png', desc: 'Di chuyển bằng xe giường nằm, đưa đón 2 chiều từ TP HCM.' },
            { id: 'hdv', title: 'Hướng dẫn viên', icon: 'HuongDanVien-SuaLai.png', desc: 'Hướng dẫn viên chuyên nghiệp, dễ thương và nhiệt tình.' },
            { id: 'an_uong', title: 'Bữa ăn', icon: 'DoAn-SuaLai.png', desc: 'Gồm 6 bữa ăn: món nước, BBQ... trong suốt hành trình.' },
            { id: 'leu', title: 'Lều trại', icon: 'Leu-SuaLai.png', desc: 'Tiêu chuẩn 3 người/lều, bao gồm túi ngủ, cách nhiệt, gối hơi.' },
            { id: 'nuoc_uong', title: 'Nước uống', icon: 'NuocUong.png', desc: 'Tiêu chuẩn 1.5L / người / ngày trong suốt hành trình.' },
            { id: 'nuoc_tam', title: 'Nước tắm', icon: 'NuocTam-SuaLai_20260113000157.png', desc: 'Mỗi người được 15L nước sạch để tắm tại bãi camping rừng.' },
            { id: 'bao_hiem', title: 'Bảo hiểm', icon: 'BaoHiem.png', desc: 'Được trang bị bảo hiểm du lịch lên đến 70.000.000 đồng.' },
            { id: 'huy_chuong', title: 'Huy chương', icon: 'HuyChuong.png', desc: 'Được thiết kế đặc biệt, in tên và ngày kỷ niệm của đoàn.' },
            { id: 'gay', title: 'Gậy trekking', icon: 'GayTrekking.png', desc: 'Được hỗ trợ mượn gậy chất lượng, đảm bảo an toàn chuyến đi.' },
            { id: 'ao_mua', title: 'Áo mưa', icon: 'AoMua.png', desc: 'Áo mưa chuyên dụng, kèm túi ZIP bảo vệ quần áo bên trong.' },
            { id: 'chup_anh', title: 'Chụp ảnh', icon: 'ChupAnhCamera.png', desc: 'Chụp ảnh bằng máy cơ và hỗ trợ quay chụp bằng điện thoại.' },
            { id: 'grab', title: 'Grab rừng', icon: 'XeGrab.png', desc: 'Trải nghiệm ngồi xe máy băng rừng trong 5km hành trình cuối.' }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            currentUser = checkAuth();
            if (currentUser) {
                document.getElementById('sidebar-avatar').src = currentUser.avatar;
                document.getElementById('sidebar-name').textContent = currentUser.fullName;
                document.getElementById('sidebar-role').textContent = currentUser.role.toUpperCase();

                if (currentUser.role !== 'admin') {
                    document.getElementById('nav-users').classList.add('hidden');
                    document.getElementById('btn-add-tour').classList.add('hidden');
                }
            }

            renderInclusionsGrid();
            loadTours();
            syncBadges();
        });

        // UI Helpers
        function switchTab(tab) {
            const basicTab = document.getElementById('tab-basic');
            const detailTab = document.getElementById('tab-detail');
            const btnBasic = document.getElementById('tab-btn-basic');
            const btnDetail = document.getElementById('tab-btn-detail');

            if (tab === 'basic') {
                basicTab.classList.remove('hidden');
                detailTab.classList.add('hidden');
                btnBasic.classList.add('border-primary', 'text-primary');
                btnBasic.classList.remove('border-transparent', 'text-gray-400');
                btnDetail.classList.add('border-transparent', 'text-gray-400');
                btnDetail.classList.remove('border-primary', 'text-primary');
            } else {
                basicTab.classList.add('hidden');
                detailTab.classList.remove('hidden');
                btnDetail.classList.add('border-primary', 'text-primary');
                btnDetail.classList.remove('border-transparent', 'text-gray-400');
                btnBasic.classList.add('border-transparent', 'text-gray-400');
                btnBasic.classList.remove('border-primary', 'text-primary');
            }
        }

        // Dynamic Form Logic
        function addImageField(containerId, value = '') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'relative group';
            div.innerHTML = `
                <input type="text" value="${value}" placeholder="Link ảnh..." 
                    class="w-full p-2.5 rounded-lg border border-gray-100 text-[10px] outline-none focus:border-primary">
                <button type="button" onclick="this.parentElement.remove()" 
                    class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-md opacity-0 group-hover:opacity-100 transition-opacity">
                    <i data-lucide="x" class="w-3 h-3"></i>
                </button>
            `;
            container.appendChild(div);
            lucide.createIcons();
        }

        function addItineraryDay(data = { day: '', title: '', events: [] }) {
            const container = document.getElementById('itinerary-days-container');
            const dayIdx = container.children.length;
            const dayDiv = document.createElement('div');
            dayDiv.className = 'p-6 bg-gray-50 rounded-2xl border border-gray-100 space-y-4';
            dayDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="flex gap-4">
                        <input type="text" placeholder="Ngày 0" value="${data.day || ''}" class="w-24 p-2 rounded-lg border font-bold text-sm bg-white tour-itinerary-day-label">
                        <input type="text" placeholder="Tên ngày (VD: Khởi hành)" value="${data.title || ''}" class="w-64 p-2 rounded-lg border font-bold text-sm bg-white tour-itinerary-day-title">
                    </div>
                    <button type="button" onclick="this.parentElement.parentElement.remove()" class="text-red-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
                <div class="space-y-2 tour-day-events-container">
                    <!-- Events will be added here -->
                </div>
                <button type="button" onclick="addItineraryEvent(this)" class="text-[10px] font-bold text-primary flex items-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> Thêm mốc thời gian</button>
            `;
            container.appendChild(dayDiv);

            // Add existing events if editing
            const eventsContainer = dayDiv.querySelector('.tour-day-events-container');
            if (data.events && data.events.length > 0) {
                data.events.forEach(evt => addItineraryEvent({ parentElement: { parentElement: dayDiv } }, evt));
            } else {
                // Default 2 empty rows as requested
                addItineraryEvent({ parentElement: { parentElement: dayDiv } });
                addItineraryEvent({ parentElement: { parentElement: dayDiv } });
            }
            lucide.createIcons();
        }

        function addItineraryEvent(btn, value = '') {
            const row = document.createElement('div');
            row.className = 'flex gap-2 group items-center';

            // Split value into time and content if it contains ":"
            let time = '', content = '';
            if (value.includes(':')) {
                const parts = value.split(':');
                time = parts[0].trim();
                content = parts.slice(1).join(':').trim();
            } else {
                content = value;
            }

            row.innerHTML = `
                <input type="text" placeholder="21h45" value="${time}" class="w-20 p-2 rounded-lg border text-xs bg-white tour-event-time">
                <input type="text" placeholder="Nội dung công việc..." value="${content}" class="flex-1 p-2 rounded-lg border text-xs bg-white tour-event-content">
                <button type="button" onclick="this.parentElement.remove()" class="opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 transition-opacity"><i data-lucide="x" class="w-3 h-3"></i></button>
            `;

            // Support both direct parent (when adding) and delegated parent (when initial load)
            const list = btn.querySelector ? btn.querySelector('.tour-day-events-container') : btn.closest('.p-6').querySelector('.tour-day-events-container');
            list.appendChild(row);
            lucide.createIcons();
        }

        function renderInclusionsGrid() {
            const grid = document.getElementById('inclusions-grid');
            grid.innerHTML = '';
            DEFAULT_INCLUSIONS.forEach(item => {
                const div = document.createElement('div');
                div.className = 'inclusion-item p-3 border border-gray-100 rounded-xl flex items-start gap-3 bg-white hover:border-primary/30 transition-all cursor-pointer';
                div.onclick = () => {
                    const checkbox = div.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    div.classList.toggle('bg-primary/5', checkbox.checked);
                    div.classList.toggle('border-primary/20', checkbox.checked);
                    const icon = div.querySelector('.inclusion-icon');
                    icon.classList.toggle('grayscale', !checkbox.checked);
                    icon.classList.toggle('opacity-50', !checkbox.checked);
                };
                div.innerHTML = `
                    <input type="checkbox" id="inc-${item.id}" value="${item.id}" class="mt-1 accent-primary" onclick="event.stopPropagation()">
                    <div class="shrink-0 w-10 h-10 border border-gray-50 rounded-lg p-1">
                        <img src="../${item.icon}" class="w-full h-full object-contain grayscale opacity-50 inclusion-icon">
                    </div>
                    <div>
                        <h4 class="text-[10px] font-black uppercase text-gray-800">${item.title}</h4>
                        <textarea class="w-full mt-1 p-1 text-[9px] text-gray-400 bg-transparent border-none outline-none resize-none font-medium h-10" onclick="event.stopPropagation()">${item.desc}</textarea>
                    </div>
                `;
                grid.appendChild(div);

                const cb = div.querySelector('input');
                cb.addEventListener('change', () => {
                    const icon = div.querySelector('.inclusion-icon');
                    icon.classList.toggle('grayscale', !cb.checked);
                    icon.classList.toggle('opacity-50', !cb.checked);
                    div.classList.toggle('bg-primary/5', cb.checked);
                    div.classList.toggle('border-primary/20', cb.checked);
                });
            });
        }

        function addExclusionRow(data = { title: '', content: '' }) {
            const container = document.getElementById('exclusions-container');
            const row = document.createElement('div');
            row.className = 'flex gap-3 group items-start bg-red-50/30 p-3 rounded-xl border border-red-100';
            row.innerHTML = `
                <div class="flex-1 space-y-2">
                    <input type="text" placeholder="Tiêu đề (VD: Gửi đồ lên bãi trại)" value="${data.title || ''}" class="w-full p-2 rounded-lg border text-xs font-bold tour-exclusion-title">
                    <input type="text" placeholder="Mô tả (VD: Mức giá 100k / balo...)" value="${data.content || ''}" class="w-full p-2 rounded-lg border text-xs text-gray-500 tour-exclusion-content">
                </div>
                <button type="button" onclick="this.parentElement.remove()" class="text-gray-300 hover:text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            `;
            container.appendChild(row);
            lucide.createIcons();
        }

        // --- Core Logic ---
        function syncBadges() {
            const LEADS_KEY = 'cam_site_leads';
            const BOOKINGS_KEY = 'cam_site_bookings';
            const leads = JSON.parse(localStorage.getItem(LEADS_KEY)) || [];
            const bookings = JSON.parse(localStorage.getItem(BOOKINGS_KEY)) || [];
            const pendingLeads = leads.filter(l => l.status === 'Chờ tư vấn').length;
            const lBadge = document.getElementById('leads-badge-count');
            if (lBadge) {
                lBadge.textContent = pendingLeads;
                lBadge.style.display = pendingLeads > 0 ? 'inline-block' : 'none';
            }
            const bBadge = document.getElementById('bookings-badge-count');
            if (bBadge) {
                bBadge.textContent = bookings.length;
                bBadge.style.display = bookings.length > 0 ? 'inline-block' : 'none';
            }
        }

        async function loadTours() {
            const tableBody = document.querySelector('tbody');
            tableBody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Đang tải dữ liệu...</td></tr>';

            try {
                const response = await fetch('/.netlify/functions/get-tours');
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.details || data.error);
                }

                tableBody.innerHTML = '';
                if (!Array.isArray(data) || data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Chưa có tour nào.</td></tr>';
                } else {
                    data.sort((a, b) => b.id - a.id).forEach(item => renderRow(item));
                }
            } catch (error) {
                console.error('Error loading tours:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="p-8 text-center">
                            <p class="text-red-500 font-bold">Lỗi khi tải dữ liệu từ Database</p>
                            <p class="text-[10px] text-gray-400 mt-1">${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }

        function renderRow(item) {
            const tableBody = document.querySelector('tbody');
            let actionButtons = '';
            if (currentUser && currentUser.role === 'admin') {
                const itemJson = JSON.stringify(item).replace(/'/g, "&apos;");
                actionButtons = `
                    <button onclick='openAddTourModal(${itemJson})' class="text-gray-400 hover:text-primary transition-colors">
                        <i data-lucide="edit-3" class="w-4 h-4"></i>
                    </button>
                    <button onclick="deleteTour(${item.id})" class="text-gray-400 hover:text-red-500 transition-colors">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
            } else {
                actionButtons = `<span class="text-gray-300 text-xs italic">Chỉ xem</span>`;
            }

            const newRow = `
                <tr class="hover:bg-gray-50/50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-lg bg-gray-100 overflow-hidden">
                                <img src="${item.image}" class="w-full h-full object-cover">
                            </div>
                            <div>
                                <span class="text-sm font-bold block">${item.name}</span>
                                <span class="text-[10px] text-gray-400 font-mono">/tour/${item.slug}</span>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-sm">${item.duration}</td>
                    <td class="px-6 py-4 text-sm font-bold text-primary">${parseInt(item.price).toLocaleString('vi-VN')}đ</td>
                    <td class="px-6 py-4">
                        <span class="bg-green-100 text-green-600 text-[10px] px-2 py-1 rounded-full font-bold">Hoạt động</span>
                    </td>
                    <td class="px-6 py-4 space-x-2">${actionButtons}</td>
                </tr>
            `;
            tableBody.insertAdjacentHTML('beforeend', newRow);
            lucide.createIcons();
        }

        async function saveTour(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.innerText;
            submitBtn.disabled = true;
            submitBtn.innerText = 'Đang đồng bộ...';

            // Collect Slideshow Images (Card)
            const cardImages = Array.from(document.getElementById('card-slideshow-container').querySelectorAll('input'))
                .map(input => input.value).filter(v => v);

            // Collect Detailed Gallery
            const galleryImages = Array.from(document.getElementById('detail-gallery-container').querySelectorAll('input'))
                .map(input => input.value).filter(v => v);

            // Collect Itinerary
            const itinerary = Array.from(document.getElementById('itinerary-days-container').children).map(dayDiv => {
                const dayLabel = dayDiv.querySelector('.tour-itinerary-day-label').value;
                const dayTitle = dayDiv.querySelector('.tour-itinerary-day-title').value;
                const events = Array.from(dayDiv.querySelectorAll('.tour-day-events-container .group')).map(row => {
                    const time = row.querySelector('.tour-event-time').value;
                    const content = row.querySelector('.tour-event-content').value;
                    return time ? `${time}: ${content}` : content;
                }).filter(v => v);
                return { day: dayLabel, title: dayTitle, events };
            });

            // Collect Inclusions
            const inclusions = [];
            DEFAULT_INCLUSIONS.forEach(item => {
                const checkbox = document.getElementById(`inc-${item.id}`);
                const text = checkbox.closest('.inclusion-item').querySelector('textarea').value;
                if (checkbox.checked) {
                    inclusions.push({ id: item.id, title: item.title, icon: item.icon, desc: text });
                }
            });

            // Collect Exclusions
            const exclusions = Array.from(document.getElementById('exclusions-container').children).map(row => {
                return {
                    title: row.querySelector('.tour-exclusion-title').value,
                    content: row.querySelector('.tour-exclusion-content').value
                };
            }).filter(v => v.title);

            const id = document.getElementById('edit-id').value;
            const tour = {
                id: id ? parseInt(id) : null,
                name: document.getElementById('tour-name').value,
                slug: document.getElementById('tour-slug').value,
                image: cardImages[0] || '', // Use first slideshow image as primary thumb
                image2: cardImages[1] || '',
                image3: cardImages[2] || '',
                image4: cardImages[3] || '',
                hero_image: document.getElementById('tour-hero-image').value,
                short_desc: document.getElementById('tour-short-desc').value,
                long_desc: document.getElementById('tour-long-desc').value,
                altitude: document.getElementById('tour-altitude').value,
                level: document.getElementById('tour-level').value,
                region: document.getElementById('tour-region').value,
                type: document.getElementById('tour-type').value,
                duration: document.getElementById('tour-duration').value,
                price: parseInt(document.getElementById('tour-price').value),
                specs: {
                    location: document.getElementById('spec-location').value,
                    duration: document.getElementById('spec-duration').value,
                    distance: document.getElementById('spec-distance').value,
                    elevation: document.getElementById('spec-elevation').value,
                    difficulty: document.getElementById('spec-difficulty').value,
                    transport: document.getElementById('spec-transport').value,
                    quantity: document.getElementById('spec-quantity').value,
                    guide_ratio: document.getElementById('spec-guide-ratio').value
                },
                itinerary: itinerary,
                inclusions: inclusions,
                exclusions: exclusions,
                preparation: document.getElementById('tour-note').value, // Use note field for simple preparation text or extend later
                gallery: galleryImages
            };

            try {
                const response = await fetch('/.netlify/functions/save-tour', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(tour)
                });
                if (!response.ok) throw new Error('Cơ sở dữ liệu Neon từ chối yêu cầu.');
                alert('Dữ liệu đã được cập nhật PRO MAX!');
                loadTours();
                closeAddTourModal();
            } catch (error) {
                console.error(error);
                alert('Lỗi: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerText = originalText;
            }
        }

        async function deleteTour(id) {
            if (confirm('Bạn chắc chắn muốn xóa Tour này? Hành động này không thể hoàn tác.')) {
                try {
                    const response = await fetch(`/.netlify/functions/save-tour?id=${id}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('Không thể xóa tour.');
                    alert('Đã xóa dữ liệu thành công.');
                    loadTours();
                } catch (error) {
                    alert('Lỗi: ' + error.message);
                }
            }
        }

        function openAddTourModal(editData = null) {
            const modal = document.getElementById('addTourModal');
            const title = modal.querySelector('h2');
            const submitBtn = document.getElementById('submit-btn');

            // Clean up old dynamic fields
            document.getElementById('card-slideshow-container').innerHTML = '';
            document.getElementById('detail-gallery-container').innerHTML = '';
            document.getElementById('itinerary-days-container').innerHTML = '';
            document.getElementById('exclusions-container').innerHTML = '';
            renderInclusionsGrid();
            switchTab('basic');

            if (editData) {
                title.innerText = 'Chỉnh Sửa Hành Trình';
                submitBtn.innerText = 'Cập nhật PRO MAX';
                document.getElementById('edit-id').value = editData.id;
                document.getElementById('tour-name').value = editData.name;
                document.getElementById('tour-slug').value = editData.slug;
                document.getElementById('tour-hero-image').value = editData.hero_image || '';
                document.getElementById('tour-short-desc').value = editData.short_desc || '';
                document.getElementById('tour-long-desc').value = editData.long_desc || '';
                document.getElementById('tour-altitude').value = editData.altitude || '';
                document.getElementById('tour-level').value = editData.level || 'Trung Bình';
                document.getElementById('tour-region').value = editData.region || 'Miền Nam';
                document.getElementById('tour-type').value = editData.type || 'TREKKING';
                document.getElementById('tour-duration').value = editData.duration;
                document.getElementById('tour-price').value = editData.price;
                document.getElementById('tour-note').value = editData.preparation || '';

                // Restore Card Slideshow
                const cardImgs = [editData.image, editData.image2, editData.image3, editData.image4].filter(v => v);
                cardImgs.forEach(img => addImageField('card-slideshow-container', img));
                if (cardImgs.length === 0) addImageField('card-slideshow-container');

                // Restore Detail Gallery
                if (editData.gallery && editData.gallery.length > 0) {
                    editData.gallery.forEach(img => addImageField('detail-gallery-container', img));
                } else {
                    addImageField('detail-gallery-container');
                    addImageField('detail-gallery-container');
                    addImageField('detail-gallery-container');
                }

                // Restore Specs
                const s = editData.specs || {};
                document.getElementById('spec-location').value = s.location || '';
                document.getElementById('spec-duration').value = s.duration || '';
                document.getElementById('spec-distance').value = s.distance || '';
                document.getElementById('spec-elevation').value = s.elevation || '';
                document.getElementById('spec-difficulty').value = s.difficulty || '';
                document.getElementById('spec-transport').value = s.transport || '';
                document.getElementById('spec-quantity').value = s.quantity || '';
                document.getElementById('spec-guide-ratio').value = s.guide_ratio || '';

                // Restore Itinerary
                if (editData.itinerary && editData.itinerary.length > 0) {
                    editData.itinerary.forEach(day => addItineraryDay(day));
                } else {
                    addItineraryDay({ day: 'Ngày 0', title: 'Khởi hành', events: [] });
                }

                // Restore Inclusions
                if (editData.inclusions && editData.inclusions.length > 0) {
                    editData.inclusions.forEach(inc => {
                        const cb = document.getElementById(`inc-${inc.id}`);
                        if (cb) {
                            cb.checked = true;
                            const div = cb.closest('.inclusion-item');
                            div.classList.add('bg-primary/5', 'border-primary/20');
                            const icon = div.querySelector('.inclusion-icon');
                            icon.classList.remove('grayscale', 'opacity-50');
                            div.querySelector('textarea').value = inc.desc;
                        }
                    });
                }

                // Restore Exclusions
                if (editData.exclusions && editData.exclusions.length > 0) {
                    editData.exclusions.forEach(ex => addExclusionRow(ex));
                }

            } else {
                title.innerText = 'Thêm Hành Trình Mới';
                submitBtn.innerText = 'Lưu Hành Trình';
                document.getElementById('addTourForm').reset();
                document.getElementById('edit-id').value = '';

                // Defaults
                addImageField('card-slideshow-container');
                addImageField('detail-gallery-container');
                addImageField('detail-gallery-container');
                addImageField('detail-gallery-container');
                addItineraryDay({ day: 'Ngày 0', title: 'Khởi hành', events: [] });
                addExclusionRow();
            }
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            lucide.createIcons();
        }

        function closeAddTourModal() {
            const modal = document.getElementById('addTourModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // Auto Slug Generation
        document.getElementById('tour-name').addEventListener('input', function (e) {
            const slugInput = document.getElementById('tour-slug');
            if (document.getElementById('edit-id').value) return; // Don't auto-change slug when editing

            const name = e.target.value;
            const slug = name.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[đĐ]/g, 'd')
                .replace(/([^0-9a-z-\s])/g, '')
                .replace(/(\s+)/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-+|-+$/g, '');
            slugInput.value = slug;
        });
    </script>
</body>

</html>