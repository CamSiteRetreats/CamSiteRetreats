<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết Tour | CAM SITE RETREATS</title>

    <!-- Dynamic Meta Tags for SEO & Social Preview -->
    <meta name="description" id="meta-desc"
        content="Khám phá hành trình trải nghiệm thiên nhiên tuyệt vời cùng CAM SITE RETREATS.">
    <meta property="og:title" id="og-title" content="Chi tiết Tour | CAM SITE RETREATS">
    <meta property="og:description" id="og-desc"
        content="Khám phá hành trình trải nghiệm thiên nhiên tuyệt vời cùng CAM SITE RETREATS.">
    <meta property="og:image" id="og-image" content="">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="../js/tour-manager.js"></script>
    <script src="../js/ui-components.js"></script>
    <style>
        :root {
            --primary: #E85D04;
            --secondary: #FFF8F0;
            --text: #333333;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--secondary);
            color: var(--text);
        }

        .hero-title {
            text-shadow: 0 4px 30px rgba(0, 0, 0, 0.4);
        }

        .content-card {
            background: white;
            border-radius: 32px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(0, 0, 0, 0.03);
        }

        .itinerary-step::before {
            content: '';
            position: absolute;
            left: 0;
            top: 24px;
            bottom: -32px;
            width: 2px;
            background: #f1f1f1;
            margin-left: 20px;
        }

        .itinerary-step:last-child::before {
            display: none;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #e2e2e2;
            border-radius: 10px;
        }
    </style>
</head>

<body class="overflow-x-hidden opacity-0 transition-opacity duration-700">
    <div id="header-placeholder"></div>

    <!-- Hero Section -->
    <section class="relative h-[80vh] w-full flex items-center justify-center overflow-hidden">
        <img id="tour-hero" src="" class="absolute inset-0 w-full h-full object-cover" alt="Tour Hero">
        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"></div>
        <div class="relative z-10 text-center px-6 max-w-5xl">
            <span id="tour-category"
                class="bg-primary text-white text-[10px] font-black px-6 py-2.5 rounded-full uppercase tracking-[0.2em] mb-8 inline-block animate__animated animate__fadeInDown"></span>
            <h1 id="tour-title"
                class="hero-title text-4xl md:text-7xl font-black text-white uppercase leading-[1.1] mb-8 animate__animated animate__zoomIn">
            </h1>
            <div
                class="flex flex-wrap justify-center gap-4 text-white/90 text-[10px] font-bold uppercase tracking-widest animate__animated animate__fadeInUp">
                <span class="flex items-center gap-2 bg-white/10 backdrop-blur-md px-5 py-3 rounded-2xl"><i
                        data-lucide="clock" class="w-4 h-4"></i> <span id="hero-duration"></span></span>
                <span class="flex items-center gap-2 bg-white/10 backdrop-blur-md px-5 py-3 rounded-2xl"><i
                        data-lucide="mountain" class="w-4 h-4"></i> <span id="hero-altitude"></span></span>
                <span class="flex items-center gap-2 bg-white/10 backdrop-blur-md px-5 py-3 rounded-2xl"><i
                        data-lucide="dumbbell" class="w-4 h-4"></i> <span id="hero-level"></span></span>
            </div>
        </div>
    </section>

    <!-- Specs Bar -->
    <div class="max-w-7xl mx-auto px-6 -mt-12 relative z-20">
        <div id="tour-specs-grid"
            class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 bg-white p-6 rounded-[32px] shadow-2xl shadow-black/5 border border-gray-100">
            <!-- Dynamic Specs -->
        </div>
    </div>

    <!-- Content -->
    <section class="py-20 px-6 max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-12">
        <div class="lg:col-span-2 space-y-12">
            <!-- Overview -->
            <div class="content-card p-10 md:p-14">
                <div class="flex items-center gap-4 mb-8">
                    <div class="w-12 h-1 bg-primary rounded-full"></div>
                    <h2 class="text-3xl font-black uppercase text-gray-800 tracking-tight">Hành trình</h2>
                </div>
                <div id="tour-long-desc" class="text-gray-500 leading-relaxed text-lg space-y-6 font-medium"></div>
            </div>

            <!-- Itinerary -->
            <div class="content-card p-10 md:p-14">
                <div class="flex items-center gap-4 mb-12">
                    <div class="w-12 h-1 bg-primary rounded-full"></div>
                    <h2 class="text-3xl font-black uppercase text-gray-800 tracking-tight">Lịch trình</h2>
                </div>
                <div id="tour-itinerary-list" class="space-y-16"></div>
            </div>

            <!-- Inclusions -->
            <div class="content-card p-10 md:p-14">
                <div class="flex items-center gap-4 mb-12">
                    <div class="w-12 h-1 bg-primary rounded-full"></div>
                    <h2 class="text-3xl font-black uppercase text-gray-800 tracking-tight">Trải nghiệm gồm có</h2>
                </div>
                <div id="tour-inclusions-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Dynamic Inclusions -->
                </div>
            </div>

            <!-- Exclusions & Notes -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Exclusions -->
                <div class="content-card p-10 bg-gray-900 border-none">
                    <h3 class="text-xl font-black uppercase text-white mb-8 border-l-4 border-red-500 pl-4">Chưa bao gồm
                    </h3>
                    <div id="tour-exclusions-list" class="space-y-6">
                        <!-- Dynamic Exclusions -->
                    </div>
                </div>
                <!-- Note -->
                <div class="content-card p-10 bg-primary/5 border-primary/20">
                    <h3 class="text-xl font-black uppercase text-primary mb-8 border-l-4 border-primary pl-4">Lưu ý nhỏ
                    </h3>
                    <div id="tour-note" class="text-gray-500 font-medium leading-relaxed italic"></div>
                </div>
            </div>

            <!-- Gallery -->
            <div id="gallery-section" class="space-y-8">
                <h2 class="text-4xl font-black uppercase text-gray-800 tracking-tighter text-center mb-12">Cảm xúc hành
                    trình</h2>
                <div id="tour-gallery" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            </div>
        </div>

        <!-- Sidebar / Booking -->
        <div class="space-y-8">
            <div class="content-card p-8 sticky top-24 border-2 border-primary/10 overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-primary/5 rounded-full -mr-16 -mt-16 blur-3xl"></div>

                <div class="mb-10 p-8 bg-primary/5 rounded-[24px] border border-primary/10 text-center relative z-10">
                    <p class="text-[10px] font-black text-primary uppercase tracking-[0.3em] mb-2 leading-none">Chi phí
                        toàn hành trình</p>
                    <p id="tour-price" class="text-4xl font-black text-gray-900 leading-none py-2"></p>
                    <p class="text-[10px] font-bold text-gray-400">/ 01 KHÁCH</p>
                </div>

                <div class="space-y-6 mb-10">
                    <h3 class="text-xs font-black uppercase text-gray-400 tracking-[0.2em] flex items-center gap-2">
                        <i data-lucide="calendar" class="w-4 h-4"></i> Lịch gần nhất
                    </h3>
                    <div id="tour-schedules" class="space-y-3">
                        <div
                            class="flex items-center justify-between p-4 bg-gray-50 rounded-2xl border border-gray-100">
                            <div>
                                <p class="text-xs font-black text-gray-800">THU 7, 21/04 - 22/04</p>
                                <p class="text-[10px] font-bold text-green-500 uppercase">Còn 04 chỗ</p>
                            </div>
                            <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center"><i
                                    data-lucide="chevron-right" class="w-4 h-4 text-primary"></i></div>
                        </div>
                    </div>
                </div>

                <button onclick="window.location.href='#booking'"
                    class="w-full bg-gray-900 text-white py-6 rounded-2xl font-black text-lg hover:bg-primary transition-all shadow-2xl shadow-gray-200 active:scale-95 group flex items-center justify-center gap-3">
                    BẮT ĐẦU TRẢI NGHIỆM
                    <i data-lucide="arrow-right" class="w-5 h-5 group-hover:translate-x-1 transition-transform"></i>
                </button>

                <p
                    class="text-[10px] text-center mt-6 text-gray-400 font-bold uppercase tracking-widest leading-relaxed">
                    Đảm bảo an toàn 100%<br>Bảo hiểm du lịch cho mọi đoàn</p>
            </div>
        </div>
    </section>

    <!-- Related Tours -->
    <section class="py-32 bg-white">
        <div class="max-w-7xl mx-auto px-6">
            <div class="flex items-end justify-between mb-16 px-4">
                <div>
                    <h2 class="text-[10px] font-black text-primary uppercase tracking-[0.4em] mb-4">Gợi ý dành cho bạn
                    </h2>
                    <h3 class="text-4xl font-black uppercase text-gray-800 tracking-tight">Hành trình tương tự</h3>
                </div>
                <a href="../tours.html"
                    class="text-xs font-black text-gray-400 hover:text-primary transition-all uppercase tracking-widest border-b-2 border-transparent hover:border-primary pb-1">Xem
                    tất cả</a>
            </div>
            <div id="related-tours" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Recommendations will be injected here -->
            </div>
        </div>
    </section>

    <div id="footer-placeholder"></div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            let slug = urlParams.get('slug');

            // Fallback: Lấy slug từ đường dẫn /tour/:slug nếu dùng Rewrite của Vercel
            if (!slug) {
                const pathParts = window.location.pathname.split('/');
                const tourIdx = pathParts.indexOf('tour');
                if (tourIdx !== -1 && pathParts[tourIdx + 1]) {
                    slug = pathParts[tourIdx + 1];
                }
            }

            if (!slug) {
                console.warn("Không tìm thấy slug trong URL.");
                window.location.href = '../index.html';
                return;
            }

            try {
                // Fetch Tours
                const res = await fetch(`/api/get-tours?t=${Date.now()}`);
                if (!res.ok) throw new Error(`Lỗi Server (${res.status})`);

                const tours = await res.json();
                if (!Array.isArray(tours)) {
                    throw new Error(tours.error || tours.details || 'Dữ liệu không hợp lệ');
                }

                const tour = tours.find(t => t.slug === slug);
                if (!tour) {
                    console.log("Slugs hiện có trong DB:", tours.map(t => t.slug));
                    throw new Error(`Hành trình với mã "${slug}" không tồn tại trong hệ thống.`);
                }

                // --- SEO & SOCIAL PREVIEW ---
                document.title = `${tour.name} | CAM SITE RETREATS`;
                const metaTitle = `${tour.name} - Trải nghiệm Trekking đẳng cấp cùng CAM SITE`;
                const metaDesc = tour.short_desc || "Khám phá hành trình trải nghiệm thiên nhiên tuyệt vời cùng CAM SITE RETREATS.";
                const metaImage = tour.hero_image || tour.image;

                document.getElementById('meta-desc').content = metaDesc;
                document.getElementById('og-title').content = metaTitle;
                document.getElementById('og-desc').content = metaDesc;
                document.getElementById('og-image').content = metaImage;

                // --- RENDER HERO ---
                document.getElementById('tour-title').innerText = tour.name;
                document.getElementById('tour-hero').src = metaImage;
                document.getElementById('tour-category').innerText = `${tour.type || 'TREKKING'} | ${tour.region || 'MIỀN NAM'}`;
                document.getElementById('hero-duration').innerText = tour.duration;
                document.getElementById('hero-altitude').innerText = tour.altitude;
                document.getElementById('hero-level').innerText = tour.level || 'Trung Bình';

                // --- RENDER PRICE ---
                document.getElementById('tour-price').innerText = parseInt(tour.price).toLocaleString('vi-VN') + 'đ';

                // --- RENDER LONG DESC ---
                document.getElementById('tour-long-desc').innerHTML = tour.long_desc ? tour.long_desc.replace(/\n/g, '<br>') : tour.short_desc;
                document.getElementById('tour-note').innerText = tour.preparation || 'Chuyến đi không yêu cầu chuẩn bị gì quá đặc biệt. Hãy mang theo tinh thần sẵn sàng khám phá!';

                // --- RENDER SPECS (8 Items) ---
                const s = tour.specs || {};
                const specsMap = [
                    { icon: 'map-pin', label: 'Địa điểm', val: s.location || '---' },
                    { icon: 'clock', label: 'Thời gian', val: s.duration || tour.duration },
                    { icon: 'footprints', label: 'Quãng đường', val: s.distance || '---' },
                    { icon: 'mountain', label: 'Độ cao', val: s.elevation || tour.altitude },
                    { icon: 'dumbbell', label: 'Độ khó', val: s.difficulty || tour.level },
                    { icon: 'bus', label: 'Di chuyển', val: s.transport || '---' },
                    { icon: 'users', label: 'Số lượng', val: s.quantity || '---' },
                    { icon: 'shield-check', label: 'Tỷ lệ HDV', val: s.guide_ratio || '---' }
                ];
                document.getElementById('tour-specs-grid').innerHTML = specsMap.map(spec => `
                    <div class="flex flex-col items-center text-center p-3">
                        <div class="w-10 h-10 rounded-xl bg-primary/10 flex items-center justify-center mb-3">
                            <i data-lucide="${spec.icon}" class="w-5 h-5 text-primary"></i>
                        </div>
                        <p class="text-[8px] font-black uppercase text-gray-400 tracking-tighter mb-1">${spec.label}</p>
                        <p class="text-[10px] font-black text-gray-800 leading-tight">${spec.val}</p>
                    </div>
                `).join('');

                // --- RENDER ITINERARY ---
                const itinerary = tour.itinerary || [];
                const itineraryList = document.getElementById('tour-itinerary-list');
                itineraryList.innerHTML = itinerary.map((day, idx) => `
                    <div class="relative pl-16 itinerary-step">
                        <div class="absolute left-0 top-0 w-10 h-10 rounded-2xl bg-primary flex items-center justify-center text-white font-black text-xs shadow-lg shadow-primary/30 z-10">
                            0${idx + 1}
                        </div>
                        <h4 class="text-2xl font-black text-gray-800 uppercase mb-8 tracking-tighter">${day.day || `Ngày ${idx + 1}`}: ${day.title}</h4>
                        <div class="space-y-4">
                            ${(day.events || []).map(event => {
                    let time = '', content = '';
                    if (event.includes(':')) {
                        const parts = event.split(':');
                        time = parts[0].trim();
                        content = parts.slice(1).join(':').trim();
                    } else {
                        content = event;
                    }
                    return `
                                    <div class="flex gap-6 items-start group">
                                        <div class="w-16 h-8 bg-gray-50 border border-gray-100 rounded-lg flex items-center justify-center shrink-0">
                                            <span class="text-[10px] font-black text-primary">${time}</span>
                                        </div>
                                        <p class="text-gray-500 font-medium text-sm pt-1 leading-relaxed group-hover:text-gray-800 transition-colors">${content}</p>
                                    </div>
                                `;
                }).join('')}
                        </div>
                    </div>
                `).join('');

                // --- RENDER INCLUSIONS (12 Items) ---
                const inclusions = tour.inclusions || [];
                document.getElementById('tour-inclusions-grid').innerHTML = inclusions.map(inc => `
                    <div class="flex gap-5 group">
                        <div class="w-16 h-16 rounded-[20px] bg-primary/10 flex items-center justify-center shrink-0 group-hover:bg-primary group-hover:rotate-6 transition-all duration-500">
                            <img src="../${inc.icon}" class="w-10 h-10 object-contain group-hover:brightness-0 group-hover:invert transition-all">
                        </div>
                        <div>
                            <h5 class="text-sm font-black text-gray-800 uppercase tracking-widest mb-1 group-hover:text-primary transition-colors">${inc.title}</h5>
                            <p class="text-xs text-gray-400 font-medium italic leading-relaxed">${inc.desc}</p>
                        </div>
                    </div>
                `).join('');

                // --- RENDER EXCLUSIONS ---
                const exclusions = tour.exclusions || [];
                document.getElementById('tour-exclusions-list').innerHTML = exclusions.map(ex => `
                    <div class="flex gap-4">
                        <div class="mt-1.5"><i data-lucide="x-circle" class="w-4 h-4 text-red-500/50"></i></div>
                        <div>
                            <p class="text-sm font-black text-white/90 uppercase tracking-wider mb-1">${ex.title}</p>
                            <p class="text-xs text-white/40 font-medium italic">${ex.content}</p>
                        </div>
                    </div>
                `).join('');

                // --- RENDER GALLERY ---
                const gallery = tour.gallery || [];
                if (gallery.length > 0) {
                    document.getElementById('tour-gallery').innerHTML = gallery.map((img, idx) => `
                        <div class="h-80 rounded-[24px] overflow-hidden shadow-2xl group relative ${idx % 3 === 0 ? 'md:col-span-2' : ''}">
                            <img src="${img}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-1000">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-end p-6">
                                <p class="text-white text-[10px] font-black uppercase tracking-[0.2em]">KHOẢNH KHẮC CHIẾN BINH</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('gallery-section').classList.add('hidden');
                }

                // Render Recommendations
                TourManager.renderRecommendations('related-tours', tour.id, 3);

                document.body.classList.remove('opacity-0');
                lucide.createIcons();

                // Load Dynamic Parts (Header/Footer)
                UIComponents.initHeader();
                UIComponents.initFooter();

            } catch (err) {
                console.error(err);
                alert('Không tìm thấy thông tin tour này.');
                window.location.href = '../index.html';
            }
        });
    </script>
</body>

</html>